<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Pending Reports - Charlie Kirk Memorial</title>
    <link rel="icon" type="image/png" href="/static/logo.png">
    <link rel="stylesheet" href="/static/style.css">
    <style>
    /* scoped lightbox / thumb styles */
    .lightbox-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 99999; padding: 20px; }
    .lightbox-overlay.visible { display:flex; }
    .lightbox-container { position: relative; max-width: 95%; max-height: 95%; display:flex; align-items:center; justify-content:center; }
    .lightbox-image { max-width:100%; max-height:100%; border-radius:8px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
    .lightbox-close { position:absolute; top:8px; right:8px; background: rgba(0,0,0,0.6); color:#fff; border:none; font-size:20px; width:36px; height:36px; border-radius:6px; cursor:pointer; }
    .lightbox-arrow { position:absolute; top:50%; transform:translateY(-50%); background: rgba(0,0,0,0.5); color:#fff; border:none; font-size:28px; width:48px; height:72px; cursor:pointer; border-radius:6px; }
    .lightbox-arrow.left { left:8px; } .lightbox-arrow.right { right:8px; }
    .thumb, .evidence-image { cursor: zoom-in; max-width:100%; border-radius:4px; display:block; margin:8px 0; }
    .lightbox-caption { margin-top:10px; color:#fff; font-size:0.95rem; text-align:center; max-width:90%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    @media (max-width:720px){ .lightbox-arrow { width:42px; height:56px; font-size:22px; } }
    </style>
</head>
<body>
<header class="header">
    <div class="header-container">
        <h1>CHARLIE KIRK MEMORIAL</h1>
        <nav>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/report">Report</a></li>
                <li><a href="/reports">Reports</a></li>
            </ul>
        </nav>
    </div>
</header>

<main class="reports-section">
    <div class="section-header">
        <h2>Pending Reports</h2>
        <p class="subtitle">Queued for review — approve or deny.</p>
    </div>

    <div class="reports-grid">
        {# html-only dedupe so duplicates won't render #}
        {% set _seen_sigs = [] %}

        {% for report in reports %}
            {% set sig = (report.full_name or '') ~ '|' ~ (report.platform or '') ~ '|' ~ (report.description or '') ~ '|' ~ (report.evidence_url or '') %}
            {% if sig in _seen_sigs %}
                {# skip duplicate rendering #}
            {% else %}
                {% set _seen_sigs = _seen_sigs + [sig] %}

                <article class="report-card" role="article" aria-labelledby="p-{{ report.id }}" data-id="{{ report.id }}">
                    <header class="report-card-header">
                        <h3 id="p-{{ report.id }}">{{ report.full_name or "Anonymous" }}</h3>
                        <div class="meta">
                            <span class="meta-item">{{ report.location or 'N/A' }}</span>
                            <span class="meta-sep">•</span>
                            <span class="meta-item">{{ report.platform or 'Unknown' }}</span>
                        </div>
                    </header>

                    <div class="report-card-body">
                        <p class="small"><strong>Category:</strong> {{ report.category }}</p>
                        <p class="small"><strong>Occupation:</strong> {{ report.occupation or 'N/A' }}</p>
                        <p class="small"><strong>Employer:</strong> {{ report.employer or 'N/A' }}</p>
                        <p class="small"><strong>Address:</strong> {{ report.address or 'N/A' }}</p>
                        <p class="small"><strong>Phone:</strong> {{ report.phone or 'N/A' }}</p>
                        <p class="small"><strong>Their Emails:</strong> {{ report.employer_email or 'N/A' }}</p>
                        <p class="desc">{{ report.description }}</p>

                        <div class="report-evidence">
                            {# ========================
                               Build image_list robustly from any likely shape:
                               - report.image_urls (list)
                               - report.image_urls (string: newline/comma list)
                               - report.image_urls (json-like string ["url","url"])
                               - report.image_list, report.images_only, report.images, report.imageUrls
                               ======================== #}

                            {% set image_list = [] %}

                            {# 1) if report.image_urls exists #}
                            {% if report.image_urls %}
                                {% if report.image_urls is string %}
                                    {% set raw = report.image_urls.strip() %}
                                    {% if raw.startswith('[') and raw.endswith(']') %}
                                        {# JSON-like array string: remove brackets then split by commas, strip quotes/spaces #}
                                        {% set inner = raw[1:-1] %}
                                        {% for part in inner.split(',') %}
                                            {% set p = part.strip().strip('"').strip("'") %}
                                            {% if p %}
                                                {% set image_list = image_list + [p] %}
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        {# newline/comma separated plain text pasted list #}
                                        {% for line in report.image_urls.splitlines() %}
                                            {% for part in line.split(',') %}
                                                {% set u = part.strip() %}
                                                {% if u.startswith('<') and u.endswith('>') %}
                                                    {% set u = u[1:-1].strip() %}
                                                {% endif %}
                                                {% set u = u.strip().strip('"').strip("'") %}
                                                {% if u %}
                                                    {% set image_list = image_list + [u] %}
                                                {% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                    {% endif %}
                                {% else %}
                                    {# assume iterable/list-like #}
                                    {% for item in report.image_urls %}
                                        {% if item %}
                                            {% set u = item %}
                                            {% if u is string %}
                                                {% set u = u.strip() %}
                                                {% if u.startswith('<') and u.endswith('>') %}
                                                    {% set u = u[1:-1].strip() %}
                                                {% endif %}
                                                {% set u = u.strip().strip('"').strip("'") %}
                                            {% endif %}
                                            {% if u %}
                                                {% set image_list = image_list + [u] %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endif %}

                            {# 2) check other common keys that might be present (image_list, images_only, images, imageUrls) #}
                            {% if report.image_list %}
                                {% if report.image_list is string %}
                                    {% for line in report.image_list.splitlines() %}
                                        {% for part in line.split(',') %}
                                            {% set v = part.strip() %}
                                            {% if v %}
                                                {% set image_list = image_list + [v] %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                {% else %}
                                    {% for item in report.image_list %}
                                        {% if item %}{% set image_list = image_list + [item] %}{% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endif %}

                            {% if report.images_only %}
                                {% if report.images_only is string %}
                                    {% for line in report.images_only.splitlines() %}
                                        {% for part in line.split(',') %}
                                            {% set v = part.strip() %}
                                            {% if v %}{% set image_list = image_list + [v] %}{% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                {% else %}
                                    {% for item in report.images_only %}{% if item %}{% set image_list = image_list + [item] %}{% endif %}{% endfor %}
                                {% endif %}
                            {% endif %}

                            {% if report.images %}
                                {% if report.images is string %}
                                    {% for line in report.images.splitlines() %}
                                        {% for part in line.split(',') %}
                                            {% set v = part.strip() %}
                                            {% if v %}{% set image_list = image_list + [v] %}{% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                {% else %}
                                    {% for item in report.images %}{% if item %}{% set image_list = image_list + [item] %}{% endif %}{% endfor %}
                                {% endif %}
                            {% endif %}

                            {% if report.imageUrls %}
                                {% if report.imageUrls is string %}
                                    {% for line in report.imageUrls.splitlines() %}
                                        {% for part in line.split(',') %}
                                            {% set v = part.strip() %}
                                            {% if v %}{% set image_list = image_list + [v] %}{% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                {% else %}
                                    {% for item in report.imageUrls %}{% if item %}{% set image_list = image_list + [item] %}{% endif %}{% endfor %}
                                {% endif %}
                            {% endif %}

                            {# sanitize and dedupe while preserving order #}
                            {% set seen = [] %}
                            {% set normalized_list = [] %}
                            {% for u in image_list %}
                                {% if u is string %}
                                    {% set uu = u.strip() %}
                                    {% if uu.startswith('<') and uu.endswith('>') %}{% set uu = uu[1:-1].strip() %}{% endif %}
                                    {% set uu = uu.strip().strip('"').strip("'") %}
                                    {% if uu and uu not in seen %}
                                        {% set seen = seen + [uu] %}
                                        {% set normalized_list = normalized_list + [uu] %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {# final image_list now in normalized_list #}
                            {% set image_list = normalized_list %}

                            {# --- Determine images_only by extension check (strip ?/# for check) --- #}
                            {% set img_exts = ['jpg','jpeg','png','gif','webp','bmp','svg'] %}
                            {% set images_only = [] %}
                            {% if report.evidence_url %}
                                {% set ev = report.evidence_url %}
                                {% if ev is string %}
                                    {% set ev2 = ev.strip() %}
                                    {% if ev2.startswith('<') and ev2.endswith('>') %}{% set ev2 = ev2[1:-1].strip() %}{% endif %}
                                    {% set candidate = ev2.split('?')[0].split('#')[0].rstrip('/') %}
                                    {% set ext = candidate.rsplit('.',1)[-1]|lower if '.' in candidate else '' %}
                                    {% if ext in img_exts %}
                                        {% set images_only = images_only + [ev] %}
                                    {% endif %}
                                {% endif %}
                            {% endif %}

                            {% for url in image_list %}
                                {% set u = url %}
                                {% set candidate = u.split('?')[0].split('#')[0].rstrip('/') %}
                                {% set ext = candidate.rsplit('.',1)[-1]|lower if '.' in candidate else '' %}
                                {% if ext in img_exts and (u not in images_only) %}
                                    {% set images_only = images_only + [u] %}
                                {% endif %}
                            {% endfor %}

                            {# --- Render evidence_url (image only when extension matches) --- #}
                            {% if report.evidence_url %}
                                {% set evsrc = report.evidence_url %}
                                {% if evsrc is string %}
                                    {% set ev2 = evsrc.strip() %}
                                    {% if ev2.startswith('<') and ev2.endswith('>') %}{% set ev2 = ev2[1:-1].strip() %}{% endif %}
                                    {% set chk = ev2.split('?')[0].split('#')[0].rstrip('/') %}
                                    {% set ext = chk.rsplit('.',1)[-1]|lower if '.' in chk else '' %}
                                    {% if ext in img_exts %}
                                        <img src="{{ report.evidence_url }}" alt="Evidence" class="evidence-image" loading="lazy">
                                    {% else %}
                                        <a href="{{ report.evidence_url }}" class="evidence-link" target="_blank" rel="noopener noreferrer">View evidence</a>
                                    {% endif %}
                                {% endif %}
                            {% endif %}

                            {# --- Render gallery thumbnails (only those with valid extension) --- #}
                            {% if image_list and image_list|length > 0 %}
                                <div class="evidence-gallery">
                                    {% for url in image_list %}
                                        {% set u = url %}
                                        {% set candidate = u.split('?')[0].split('#')[0].rstrip('/') %}
                                        {% set ext = candidate.rsplit('.',1)[-1]|lower if '.' in candidate else '' %}
                                        {% if ext in img_exts %}
                                            <img src="{{ url }}" alt="Additional evidence" class="thumb" loading="lazy">
                                        {% else %}
                                            <a href="{{ url }}" class="evidence-link" target="_blank" rel="noopener noreferrer">View link</a>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}

                        </div>

                        {# provide JS lightbox with only the image-extension-matching urls #}
                        <script type="application/json" data-report-images-for="{{ report.id }}">
                            {{ (images_only or []) | tojson }}
                        </script>

                    </div>

                    <footer class="report-card-actions">
                        <form action="/approve/{{ report.id }}" method="post" class="action-form">
                            <button type="submit" class="admin-button small">Approve</button>
                        </form>
                        <form action="/deny/{{ report.id }}" method="post" class="action-form">
                            <button type="submit" class="deny-button small">Deny</button>
                        </form>
                    </footer>
                </article>
            {% endif %}
        {% endfor %}
    </div>
</main>

<!-- Lightbox DOM -->
<div id="lightbox" class="lightbox-overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="lightbox-container">
        <button class="lightbox-arrow left" aria-label="Previous image">&larr;</button>
        <img src="" alt="" class="lightbox-image" id="lightbox-img">
        <button class="lightbox-arrow right" aria-label="Next image">&rarr;</button>
        <button class="lightbox-close" aria-label="Close lightbox">&times;</button>
    </div>
    <div class="lightbox-caption" id="lightbox-caption"></div>
</div>

<script>
(function(){
    const imageScripts = Array.from(document.querySelectorAll('script[type="application/json"][data-report-images-for]'));
    const reportImages = {};
    imageScripts.forEach(s => {
        try {
            const id = s.getAttribute('data-report-images-for');
            const arr = JSON.parse(s.textContent || '[]');
            reportImages[id] = Array.isArray(arr) ? arr : [];
        } catch (e) {}
    });

    const lightbox = document.getElementById('lightbox');
    const imgEl = document.getElementById('lightbox-img');
    const captionEl = document.getElementById('lightbox-caption');
    const btnPrev = document.querySelector('.lightbox-arrow.left');
    const btnNext = document.querySelector('.lightbox-arrow.right');
    const btnClose = document.querySelector('.lightbox-close');

    let currentGallery = [];
    let currentIndex = 0;

    function showLightbox(gallery, index) {
        if (!gallery || gallery.length === 0) return;
        currentGallery = gallery;
        currentIndex = Math.max(0, Math.min(index, gallery.length - 1));
        imgEl.src = currentGallery[currentIndex];
        imgEl.alt = 'Image ' + (currentIndex + 1) + ' of ' + currentGallery.length;
        captionEl.textContent = imgEl.alt;
        lightbox.classList.add('visible');
        lightbox.setAttribute('aria-hidden', 'false');
    }

    function hideLightbox() {
        lightbox.classList.remove('visible');
        lightbox.setAttribute('aria-hidden', 'true');
        imgEl.src = '';
        currentGallery = [];
        currentIndex = 0;
    }

    function showPrev() {
        if (currentGallery.length <= 1) return;
        currentIndex = (currentIndex - 1 + currentGallery.length) % currentGallery.length;
        imgEl.src = currentGallery[currentIndex];
        imgEl.alt = 'Image ' + (currentIndex + 1) + ' of ' + currentGallery.length;
        captionEl.textContent = imgEl.alt;
    }

    function showNext() {
        if (currentGallery.length <= 1) return;
        currentIndex = (currentIndex + 1) % currentGallery.length;
        imgEl.src = currentGallery[currentIndex];
        imgEl.alt = 'Image ' + (currentIndex + 1) + ' of ' + currentGallery.length;
        captionEl.textContent = imgEl.alt;
    }

    document.querySelectorAll('.report-card').forEach(card => {
        const reportId = card.getAttribute('data-id') || (card.querySelector('[id^="p-"]') && card.querySelector('[id^="p-"]').id.replace('p-',''));
        const galleryFromJSON = reportImages[reportId] || [];
        card.addEventListener('click', (ev) => {
            const target = ev.target;
            if (target.classList && (target.classList.contains('thumb') || target.classList.contains('evidence-image'))) {
                const imgs = Array.from(card.querySelectorAll('.evidence-image, .thumb')).map(el => el.src).filter(Boolean);
                const actualGallery = imgs.length ? imgs : galleryFromJSON;
                if (actualGallery.length === 0) return;
                const clickedSrc = target.src || target.getAttribute('src');
                let idx = actualGallery.indexOf(clickedSrc);
                if (idx === -1) idx = 0;
                showLightbox(actualGallery, idx);
            }
        });
    });

    btnPrev.addEventListener('click', showPrev);
    btnNext.addEventListener('click', showNext);
    btnClose.addEventListener('click', hideLightbox);

    lightbox.addEventListener('click', (ev) => {
        if (ev.target === lightbox || ev.target === captionEl) hideLightbox();
    });

    document.addEventListener('keydown', (ev) => {
        if (!lightbox.classList.contains('visible')) return;
        if (ev.key === 'Escape') hideLightbox();
        if (ev.key === 'ArrowLeft') showPrev();
        if (ev.key === 'ArrowRight') showNext();
    });
})();
</script>

<script src="/static/script.js"></script>
</body>
</html>
