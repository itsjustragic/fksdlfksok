<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{{ page_title or "Reports - Charlie Kirk Memorial" }}</title>
    <link rel="icon" type="image/png" href="/static/logo.png">
    <link rel="stylesheet" href="/static/style.css">
    <style>
    /* lightbox / thumb styles (kept compact) */
    .lightbox-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; z-index:99999; padding:20px; }
    .lightbox-overlay.visible { display:flex; }
    .lightbox-container { position: relative; max-width:95%; max-height:95%; display:flex; align-items:center; justify-content:center; }
    .lightbox-image { max-width:100%; max-height:100%; border-radius:8px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
    .lightbox-close { position:absolute; top:8px; right:8px; background: rgba(0,0,0,0.6); color:#fff; border:none; font-size:20px; width:36px; height:36px; border-radius:6px; cursor:pointer; }
    .lightbox-arrow { position:absolute; top:50%; transform:translateY(-50%); background: rgba(0,0,0,0.5); color:#fff; border:none; font-size:28px; width:48px; height:72px; cursor:pointer; border-radius:6px; }
    .thumb, .evidence-image { cursor: zoom-in; max-width:100%; border-radius:4px; display:block; margin:8px 0; }
    .evidence-gallery { display:block; margin-top:8px; }
    .evidence-gallery img { max-width:180px; margin:6px; display:inline-block; vertical-align:top; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,0.35) }
    .evidence-link { display:inline-block; margin:6px 8px; padding:6px 10px; background:#222; color:#fff; border-radius:6px; text-decoration:none; }
    .report-evidence { margin-top:12px; }
    .report-card { background:#111; color:#ddd; padding:20px; border-radius:8px; box-shadow: 0 8px 28px rgba(0,0,0,0.45); margin:18px 0; }

    /* NEW: video + social styling */
    .evidence-videos { margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
    .video-item { display:flex; flex-direction:column; gap:6px; max-width:320px; }
    .video-item video { width:100%; height:auto; border-radius:8px; background:#000; }
    .video-item .video-actions { display:flex; gap:8px; align-items:center; }
    .video-item .video-actions .evidence-link { padding:6px 8px; font-size:0.9rem; }
    .video-item .copy-button { cursor:pointer; padding:6px 8px; border-radius:6px; background: rgba(255,255,255,0.04); color:#fff; border: 1px solid rgba(255,255,255,0.04); font-size:0.9rem; }
    .social-links { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .social-links a { display:inline-flex; align-items:center; gap:8px; padding:6px 8px; background: rgba(255,255,255,0.02); color:#ddd; border-radius:6px; text-decoration:none; font-size:0.9rem; border:1px solid rgba(255,255,255,0.02); }
    .social-links a:hover { background: rgba(255,255,255,0.04); color:#fff; }

    @media (max-width:720px){ .lightbox-arrow { width:42px; height:56px; font-size:22px; } }
    </style>
</head>
<body>
<header class="header">
    <div class="header-container">
        <h1>{{ header_title or "CHARLIE KIRK MEMORIAL" }}</h1>
        <nav><ul><li><a href="/">Home</a></li><li><a href="/report">Report</a></li><li><a href="/reports">Reports</a></li></ul></nav>
    </div>
</header>

<main class="reports-section">
    <div class="section-header">
        <h2>{{ section_title or "Pending Reports" }}</h2>
        <p class="subtitle">{{ subtitle or "Queued for review — approve or deny." }}</p>
    </div>

    <div class="reports-grid">
        {# Prevent duplicate rendering the same way you did before #}
        {% set _seen_sigs = [] %}
        {% for report in reports %}
            {% set sig = (report.full_name or '') ~ '|' ~ (report.platform or '') ~ '|' ~ (report.description or '') ~ '|' ~ (report.evidence_url or '') %}
            {% if sig in _seen_sigs %}
                {# skip duplicate rendering #}
            {% else %}
                {% set _seen_sigs = _seen_sigs + [sig] %}
                <article class="report-card" role="article" aria-labelledby="p-{{ report.id }}" data-id="{{ report.id }}" data-state="{{ report.state or '' }}" data-location="{{ report.location or '' }}">
                    <header class="report-card-header">
                        <h3 id="p-{{ report.id }}">{{ report.full_name or "Anonymous" }}</h3>
                        <div class="meta">
                            <span class="meta-item">{{ report.location or 'N/A' }}</span>
                            <span class="meta-sep">•</span>
                            <span class="meta-item">{{ report.platform or 'Unknown' }}</span>
                        </div>
                    </header>

                    <div class="report-card-body">
                        <p class="small"><strong>Category:</strong> {{ report.category or 'N/A' }}</p>
                        <p class="small"><strong>Occupation:</strong> {{ report.occupation or 'N/A' }}</p>
                        <p class="small"><strong>Employer:</strong> {{ report.employer or 'N/A' }}</p>
                        <p class="small"><strong>Address:</strong> {{ report.address or 'N/A' }}</p>
                        <p class="small"><strong>Phone:</strong> {{ report.phone or 'N/A' }}</p>
                        <p class="small"><strong>Their Emails:</strong> {{ report.employer_email or 'N/A' }}</p>
                        <p class="desc">{{ report.description }}</p>

                        <div class="report-evidence">
                            {# Keep your server-side evidence_url/img rendering (non-destructive) #}
                            {% if report.evidence_url %}
                                {% set ev2 = report.evidence_url %}
                                {% if ev2 is string %}
                                    {% set chk = ev2.strip() %}
                                    {% set candidate = chk.split('?')[0].split('#')[0].rstrip('/') %}
                                    {% set ext = candidate.rsplit('.',1)[-1]|lower if '.' in candidate else '' %}
                                    {% if ext in ['jpg','jpeg','png','gif','webp','bmp','svg'] %}
                                        <img src="{{ report.evidence_url }}" alt="Evidence" class="evidence-image" loading="lazy">
                                    {% elif ext in ['mp4','webm','mov','m3u8'] %}
                                        {# render a small video preview if direct video URL provided server-side #}
                                        <div class="evidence-videos">
                                          <div class="video-item">
                                            <video controls preload="metadata" poster="" crossorigin="anonymous">
                                              <source src="{{ report.evidence_url }}" type="video/{{ ext }}">
                                              Your browser does not support the video tag.
                                            </video>
                                            <div class="video-actions">
                                              <a href="{{ report.evidence_url }}" class="evidence-link" target="_blank" rel="noopener noreferrer">Open video</a>
                                              <button type="button" class="copy-button" data-copy-url="{{ report.evidence_url }}">Copy URL</button>
                                            </div>
                                          </div>
                                        </div>
                                    {% else %}
                                        <a href="{{ report.evidence_url }}" class="evidence-link" target="_blank" rel="noopener noreferrer">View evidence</a>
                                    {% endif %}
                                {% endif %}
                            {% endif %}

                            {# If the server produced any image_list/gallery on its own, allow it to render. #}
                            {% if report.image_list %}
                                {% if report.image_list is iterable and report.image_list is not string %}
                                    <div class="evidence-gallery">
                                        {% for u in report.image_list %}
                                            <img src="{{ u }}" alt="Additional evidence" class="thumb" loading="lazy">
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    {# string fallback (comma or newline separated) #}
                                    <div class="evidence-gallery">
                                        {% for line in report.image_list.splitlines() %}
                                            {% for part in line.split(',') %}
                                                {% set v = part.strip() %}
                                                {% if v %}
                                                    <img src="{{ v }}" alt="Additional evidence" class="thumb" loading="lazy">
                                                {% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endif %}

                            {# NEW: Render social links (if provided) cleanly #}
                            {% set socials = [] %}
                            {% if report.twitter_url %}{% set socials = socials + [{'label':'X/Twitter','url':report.twitter_url}] %}{% endif %}
                            {% if report.instagram_url %}{% set socials = socials + [{'label':'Instagram','url':report.instagram_url}] %}{% endif %}
                            {% if report.facebook_url %}{% set socials = socials + [{'label':'Facebook','url':report.facebook_url}] %}{% endif %}
                            {% if report.tiktok_url %}{% set socials = socials + [{'label':'TikTok','url':report.tiktok_url}] %}{% endif %}
                            {% if report.youtube_url %}{% set socials = socials + [{'label':'YouTube','url':report.youtube_url}] %}{% endif %}
                            {% if report.other_socials %}
                                {% if report.other_socials is string %}
                                    {% for line in report.other_socials.splitlines() %}
                                        {% set u = line.strip() %}
                                        {% if u %}{% set socials = socials + [{'label':'Other','url':u}] %}{% endif %}
                                    {% endfor %}
                                {% else %}
                                    {% for u in report.other_socials %}{% if u %}{% set socials = socials + [{'label':'Other','url':u}] %}{% endif %}{% endfor %}
                                {% endif %}
                            {% endif %}

                            {% if socials and socials|length > 0 %}
                                <div class="social-links" aria-label="social links">
                                    {% for s in socials %}
                                        <a href="{{ s.url }}" target="_blank" rel="noopener noreferrer">{{ s.label }}</a>
                                    {% endfor %}
                                </div>
                            {% endif %}

                            {# NEW: server-side video list rendering (report.video_urls / report.videos / report.video_url) #}
                            {% set vid_list = [] %}
                            {% if report.video_url %}{% set vid_list = vid_list + [report.video_url] %}{% endif %}
                            {% if report.video_urls %}
                                {% if report.video_urls is string %}
                                    {% for line in report.video_urls.splitlines() %}
                                        {% set u = line.strip() %}
                                        {% if u %}{% set vid_list = vid_list + [u] %}{% endif %}
                                    {% endfor %}
                                {% else %}
                                    {% for u in report.video_urls %}{% if u %}{% set vid_list = vid_list + [u] %}{% endif %}{% endfor %}
                                {% endif %}
                            {% endif %}
                            {% if report.videos %}
                                {% if report.videos is string %}
                                    {% for line in report.videos.splitlines() %}
                                        {% set u = line.strip() %}
                                        {% if u %}{% set vid_list = vid_list + [u] %}{% endif %}
                                    {% endfor %}
                                {% else %}
                                    {% for u in report.videos %}{% if u %}{% set vid_list = vid_list + [u] %}{% endif %}{% endfor %}
                                {% endif %}
                            {% endif %}

                            {% if vid_list and vid_list|length > 0 %}
                                <div class="evidence-videos" aria-label="evidence videos">
                                    {% for v in vid_list %}
                                        {% set vstr = v %}
                                        {% set vcandidate = vstr.split('?')[0].split('#')[0].rstrip('/') %}
                                        {% set vext = vcandidate.rsplit('.',1)[-1]|lower if '.' in vcandidate else '' %}
                                        <div class="video-item">
                                            {% if vext in ['mp4','webm','ogg','mov'] %}
                                                <video controls preload="metadata" crossorigin="anonymous">
                                                    <source src="{{ v }}" type="video/{{ vext }}">
                                                    Your browser does not support the video tag.
                                                </video>
                                                <div class="video-actions">
                                                    <a href="{{ v }}" class="evidence-link" target="_blank" rel="noopener noreferrer">Open video</a>
                                                    <button type="button" class="copy-button" data-copy-url="{{ v }}">Copy URL</button>
                                                </div>
                                            {% else %}
                                                <a href="{{ v }}" class="evidence-link" target="_blank" rel="noopener noreferrer">Open media</a>
                                                <button type="button" class="copy-button" data-copy-url="{{ v }}">Copy URL</button>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}

                            {# Emit JSON payloads for client-side fixer to read (images + media + socials) #}
                            <script type="application/json" data-report-images-for="{{ report.id }}">
                                {{ (report.images_only or report.image_list or report.image_urls or []) | tojson }}
                            </script>
                            <script type="application/json" data-report-media-for="{{ report.id }}">
                                {{
                                    (
                                        {
                                            "video_urls": (report.video_urls or report.videos or []),
                                            "video_url": (report.video_url or ''),
                                            "twitter_url": (report.twitter_url or ''),
                                            "instagram_url": (report.instagram_url or ''),
                                            "facebook_url": (report.facebook_url or ''),
                                            "tiktok_url": (report.tiktok_url or ''),
                                            "youtube_url": (report.youtube_url or ''),
                                            "other_socials": (report.other_socials or [])
                                        }
                                    ) | tojson
                                }}
                            </script>
                        </div>

                        <footer class="report-card-actions" style="margin-top:12px;">
                            {# Approve form now includes a hidden "state" field that we'll populate client-side #}
                            <form action="/approve/{{ report.id }}" method="post" class="action-form approve-form" style="display:inline-block;margin-right:8px;">
                                <input type="hidden" name="state" class="approve-state-input" value="{{ report.state or '' }}">
                                <button type="submit" class="admin-button small">Approve</button>
                            </form>
                            <form action="/deny/{{ report.id }}" method="post" class="action-form deny-form" style="display:inline-block;">
                                <button type="submit" class="deny-button small">Deny</button>
                            </form>
                        </footer>
                    </div>
                </article>
            {% endif %}
        {% endfor %}
    </div>
</main>

<!-- lightbox DOM (single shared instance) -->
<div id="lightbox" class="lightbox-overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="lightbox-container">
        <button class="lightbox-arrow left" aria-label="Previous image">&larr;</button>
        <img src="" alt="" class="lightbox-image" id="lightbox-img">
        <button class="lightbox-arrow right" aria-label="Next image">&rarr;</button>
        <button class="lightbox-close" aria-label="Close lightbox">&times;</button>
    </div>
    <div class="lightbox-caption" id="lightbox-caption"></div>
</div>

<script>
/* Full client-side fixer + gallery injector + video injection + copy helpers.
   Purpose: show the image/video URLs you submitted even if server-side parsing missed them,
   provide copy-URL buttons for direct video links, and surface social links when present.
*/
(function () {
    'use strict';

    const IMG_EXT_RE = /\.(jpg|jpeg|png|gif|webp|bmp|svg)(?:[?#].*)?$/i;
    const VIDEO_EXT_RE = /\.(mp4|webm|ogg|mov|m3u8|ts)(?:[?#].*)?$/i;
    const HTTP_IMG_TOKEN_RE = /\bhttps?:\/\/[^\s'"]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)(?:[?#][^\s'"]*)?/gi;
    const HTTP_VIDEO_TOKEN_RE = /\bhttps?:\/\/[^\s'"]+\.(?:mp4|webm|ogg|mov|m3u8|ts)(?:[?#][^\s'"]*)?/gi;

    function normalizeUrl(u) {
        if (!u) return '';
        u = ('' + u).trim();
        if (u.startsWith('<') && u.endsWith('>')) u = u.slice(1, -1).trim();
        if ((u.startsWith('"') && u.endsWith('"')) || (u.startsWith("'") && u.endsWith("'"))) u = u.slice(1, -1);
        return u.trim();
    }

    /* IMAGE EXTRACTION (unchanged, but local) */
    function extractImagesFromScriptPayload(card) {
        const script = card.querySelector('script[type="application/json"][data-report-images-for]');
        if (!script) return [];
        try {
            const raw = script.textContent || '[]';
            const arr = JSON.parse(raw);
            if (Array.isArray(arr)) return arr.map(normalizeUrl).filter(Boolean).filter(u => IMG_EXT_RE.test(u));
            if (typeof arr === 'string') return arr.split(/[\r\n,]+/).map(normalizeUrl).filter(Boolean).filter(u => IMG_EXT_RE.test(u));
            return [];
        } catch (e) {
            const txt = script.textContent || '';
            const found = txt.match(HTTP_IMG_TOKEN_RE) || [];
            return found.map(normalizeUrl).filter(u => IMG_EXT_RE.test(u));
        }
    }

    /* NEW: MEDIA (video + social) extraction from script payload */
    function extractMediaFromScriptPayload(card) {
        const script = card.querySelector('script[type="application/json"][data-report-media-for]');
        if (!script) return { videos: [], socials: [] };
        try {
            const raw = script.textContent || '{}';
            const obj = JSON.parse(raw);
            const videos = [];
            // normalize various possible shapes
            if (obj.video_url) videos.push(normalizeUrl(obj.video_url));
            if (obj.video_urls && Array.isArray(obj.video_urls)) videos.push(...obj.video_urls.map(normalizeUrl));
            if (obj.videos && Array.isArray(obj.videos)) videos.push(...obj.videos.map(normalizeUrl));
            if (typeof obj.video_urls === 'string') videos.push(...obj.video_urls.split(/\r?\n|,/).map(normalizeUrl));
            const socials = [];
            ['twitter_url','instagram_url','facebook_url','tiktok_url','youtube_url'].forEach(k => {
                if (obj[k]) socials.push({ key: k, url: normalizeUrl(obj[k]) });
            });
            if (obj.other_socials && Array.isArray(obj.other_socials)) obj.other_socials.forEach(u => { if (u) socials.push({ key: 'other', url: normalizeUrl(u) }); });
            if (typeof obj.other_socials === 'string') obj.other_socials.split(/\r?\n/).forEach(u => { if (u) socials.push({ key: 'other', url: normalizeUrl(u) }); });
            return { videos: videos.filter(Boolean), socials };
        } catch (e) {
            const txt = script.textContent || '';
            const foundVideos = txt.match(HTTP_VIDEO_TOKEN_RE) || [];
            const foundImgs = txt.match(HTTP_IMG_TOKEN_RE) || [];
            const socialCandidates = [];
            // basic heuristic: any remaining http(s) tokens that aren't image/video treat as social links
            const httpTokens = (txt.match(/\bhttps?:\/\/[^\s'"]+/gi) || []).map(normalizeUrl);
            httpTokens.forEach(t => {
                if (VIDEO_EXT_RE.test(t)) foundVideos.push(t);
                else if (!IMG_EXT_RE.test(t)) socialCandidates.push({ key: 'other', url: t });
            });
            return { videos: Array.from(new Set(foundVideos.map(normalizeUrl))).filter(Boolean), socials: socialCandidates };
        }
    }

    function extractFromDOMForMedia(card) {
        const videos = new Set();
        const socials = new Set();
        // scan anchors for video ext or known hosts
        Array.from(card.querySelectorAll('a[href]')).forEach(a => {
            const href = a.getAttribute('href') || '';
            if (VIDEO_EXT_RE.test(href)) videos.add(normalizeUrl(href));
            else if (!IMG_EXT_RE.test(href)) socials.add(normalizeUrl(href));
        });
        // scan text for video tokens
        const text = card.innerText || card.textContent || '';
        let m;
        while ((m = HTTP_VIDEO_TOKEN_RE.exec(text)) !== null) videos.add(normalizeUrl(m[0]));
        // also collect http tokens as socials (fallback)
        (text.match(/\bhttps?:\/\/[^\s'"]+/gi) || []).forEach(t => {
            const n = normalizeUrl(t);
            if (!VIDEO_EXT_RE.test(n) && !IMG_EXT_RE.test(n)) socials.add(n);
        });
        return { videos: Array.from(videos), socials: Array.from(socials).map(u => ({key:'other', url:u})) };
    }

    function buildGallery(card, urls) {
        if (!urls || !urls.length) return [];
        let gallery = card.querySelector('.evidence-gallery');
        let created = false;
        if (!gallery) {
            gallery = document.createElement('div');
            gallery.className = 'evidence-gallery';
            created = true;
        }
        const existing = new Set(Array.from(gallery.querySelectorAll('img')).map(i => i.src));
        const injected = [];
        urls.forEach(u => {
            if (!u) return;
            if (existing.has(u)) return;
            try {
                const img = document.createElement('img');
                img.src = u;
                img.alt = 'Additional evidence';
                img.loading = 'lazy';
                img.className = 'thumb';
                img.setAttribute('data-auto-injected', '1');
                gallery.appendChild(img);
                injected.push(u);
                existing.add(u);
            } catch (e) {
                console.warn('image-fixer: failed to create img for', u, e);
            }
        });
        if (created) {
            const evidenceContainer = card.querySelector('.report-evidence') || card.querySelector('.report-card-body') || card;
            evidenceContainer.appendChild(gallery);
        }
        return injected;
    }

    /* NEW: inject video elements / links and copy buttons */
    function ensureVideoContainer(card) {
        let cont = card.querySelector('.evidence-videos');
        if (!cont) {
            cont = document.createElement('div');
            cont.className = 'evidence-videos';
            const evidenceContainer = card.querySelector('.report-evidence') || card.querySelector('.report-card-body') || card;
            evidenceContainer.appendChild(cont);
        }
        return cont;
    }

    function injectVideos(card, urls) {
        if (!urls || !urls.length) return [];
        const cont = ensureVideoContainer(card);
        const existing = new Set(Array.from(cont.querySelectorAll('a.evidence-link, video')).map(el => el.tagName.toLowerCase() === 'video' ? (el.querySelector('source') ? el.querySelector('source').src : el.currentSrc) : el.href));
        const injected = [];
        urls.forEach(u => {
            if (!u) return;
            const n = normalizeUrl(u);
            if (existing.has(n)) return;
            try {
                const wrapper = document.createElement('div');
                wrapper.className = 'video-item';
                const vcandidate = n.split('?')[0].split('#')[0].trim();
                const ext = (vcandidate.includes('.') ? vcandidate.split('.').pop().toLowerCase() : '');
                if (VIDEO_EXT_RE.test(n) && ['mp4','webm','ogg','mov'].indexOf(ext) >= 0) {
                    const video = document.createElement('video');
                    video.controls = true;
                    video.preload = 'metadata';
                    video.crossOrigin = 'anonymous';
                    const source = document.createElement('source');
                    source.src = n;
                    source.type = 'video/' + (ext === 'mp4' ? 'mp4' : (ext === 'webm' ? 'webm' : 'ogg'));
                    video.appendChild(source);
                    wrapper.appendChild(video);
                    const actions = document.createElement('div');
                    actions.className = 'video-actions';
                    const open = document.createElement('a');
                    open.className = 'evidence-link';
                    open.href = n;
                    open.target = '_blank';
                    open.rel = 'noopener noreferrer';
                    open.textContent = 'Open video';
                    const copyBtn = document.createElement('button');
                    copyBtn.type = 'button';
                    copyBtn.className = 'copy-button';
                    copyBtn.setAttribute('data-copy-url', n);
                    copyBtn.textContent = 'Copy URL';
                    actions.appendChild(open);
                    actions.appendChild(copyBtn);
                    wrapper.appendChild(actions);
                    cont.appendChild(wrapper);
                    injected.push(n);
                } else {
                    // fallback: simple link + copy
                    const linkWrapper = document.createElement('div');
                    linkWrapper.className = 'video-item';
                    const open = document.createElement('a');
                    open.className = 'evidence-link';
                    open.href = n;
                    open.target = '_blank';
                    open.rel = 'noopener noreferrer';
                    open.textContent = 'Open media';
                    const copyBtn = document.createElement('button');
                    copyBtn.type = 'button';
                    copyBtn.className = 'copy-button';
                    copyBtn.setAttribute('data-copy-url', n);
                    copyBtn.textContent = 'Copy URL';
                    const actions = document.createElement('div');
                    actions.className = 'video-actions';
                    actions.appendChild(open);
                    actions.appendChild(copyBtn);
                    linkWrapper.appendChild(actions);
                    cont.appendChild(linkWrapper);
                    injected.push(n);
                }
            } catch (e) {
                console.warn('injectVideos: error for', n, e);
            }
        });
        return injected;
    }

    /* cross-browser copy helper */
    async function copyToClipboard(text) {
        if (!text) return Promise.reject(new Error('NO_TEXT'));
        if (navigator.clipboard && navigator.clipboard.writeText) {
            return navigator.clipboard.writeText(text);
        }
        return new Promise((resolve, reject) => {
            try {
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                resolve();
            } catch (e) {
                reject(e);
            }
        });
    }

    function wireCopyButtons(root) {
        root = root || document;
        root.querySelectorAll('.copy-button[data-copy-url]').forEach(btn => {
            if (btn.__wired) return;
            btn.addEventListener('click', async function (ev) {
                ev.preventDefault();
                ev.stopPropagation();
                const url = btn.getAttribute('data-copy-url') || '';
                if (!url) return;
                btn.disabled = true;
                const prev = btn.textContent;
                try {
                    await copyToClipboard(url);
                    btn.textContent = 'Copied';
                    setTimeout(() => { btn.textContent = prev; btn.disabled = false; }, 1500);
                } catch (e) {
                    console.error('copy failed', e);
                    btn.textContent = 'Copy failed';
                    setTimeout(() => { btn.textContent = prev; btn.disabled = false; }, 1800);
                }
            });
            btn.__wired = true;
        });
    }

    function gatherAndInjectAll() {
        const cards = Array.from(document.querySelectorAll('.report-card'));
        cards.forEach(card => {
            try {
                // images
                const imgsFromScript = extractImagesFromScriptPayload(card);
                const imgsFromDom = (function(){
                    const s = new Set();
                    Array.from(card.querySelectorAll('img')).forEach(img => { if (img.src) s.add(normalizeUrl(img.src)); });
                    Array.from(card.querySelectorAll('a')).forEach(a => { const href = a.getAttribute('href')||''; if (IMG_EXT_RE.test(href)) s.add(normalizeUrl(href)); });
                    const text = card.innerText || card.textContent || '';
                    let m;
                    while ((m = HTTP_IMG_TOKEN_RE.exec(text)) !== null) s.add(normalizeUrl(m[0]));
                    return Array.from(s);
                })();
                const imageCandidates = Array.from(new Set([...imgsFromScript, ...imgsFromDom])).filter(u => IMG_EXT_RE.test(u));
                if (imageCandidates.length) buildGallery(card, imageCandidates);

                // media (videos + socials)
                const mediaFromScript = extractMediaFromScriptPayload(card);
                const mediaFromDom = extractFromDOMForMedia(card);
                const allVideos = Array.from(new Set([...(mediaFromScript.videos||[]), ...(mediaFromDom.videos||[])]).values()).filter(Boolean);
                const allSocials = (mediaFromScript.socials||[]).concat(mediaFromDom.socials||[]).filter(Boolean);

                if (allVideos.length) {
                    const injected = injectVideos(card, allVideos);
                    if (injected.length) console.debug('Injected videos for card', card.getAttribute('data-id'), injected);
                }

                // if there are social links detected client-side but server didn't render them, append them
                if (allSocials.length) {
                    const containerExists = card.querySelector('.social-links');
                    if (!containerExists) {
                        const socialWrap = document.createElement('div');
                        socialWrap.className = 'social-links';
                        allSocials.forEach(s => {
                            try {
                                const a = document.createElement('a');
                                a.href = s.url;
                                a.target = '_blank';
                                a.rel = 'noopener noreferrer';
                                a.textContent = (s.key && s.key.replace('_url','').replace('twitter','X/Twitter')) || 'Link';
                                socialWrap.appendChild(a);
                            } catch (e) {}
                        });
                        const evidenceContainer = card.querySelector('.report-evidence') || card.querySelector('.report-card-body') || card;
                        evidenceContainer.appendChild(socialWrap);
                    }
                }

            } catch (e) {
                console.error('gatherAndInjectAll error for card', card, e);
            }
        });

        // wire copy buttons after injection
        wireCopyButtons(document);
    }

    /* Lightbox wiring (reuse existing DOM) */
    const lightbox = document.getElementById('lightbox');
    const lbImg = document.getElementById('lightbox-img');
    const lbCaption = document.getElementById('lightbox-caption');
    const btnPrev = document.querySelector('.lightbox-arrow.left');
    const btnNext = document.querySelector('.lightbox-arrow.right');
    const btnClose = document.querySelector('.lightbox-close');
    let currentGallery = [];
    let currentIndex = 0;
    function showLightbox(gallery, index) {
        if (!gallery || !gallery.length) return;
        currentGallery = gallery.slice();
        currentIndex = Math.max(0, Math.min(index || 0, currentGallery.length - 1));
        lbImg.src = currentGallery[currentIndex];
        lbImg.alt = 'Image ' + (currentIndex + 1) + ' of ' + currentGallery.length;
        lbCaption.textContent = lbImg.alt;
        lightbox.classList.add('visible');
        lightbox.setAttribute('aria-hidden', 'false');
    }
    function hideLightbox() {
        lightbox.classList.remove('visible');
        lightbox.setAttribute('aria-hidden', 'true');
        lbImg.src = '';
        currentGallery = [];
        currentIndex = 0;
    }
    function showPrev() {
        if (!currentGallery.length) return;
        currentIndex = (currentIndex - 1 + currentGallery.length) % currentGallery.length;
        lbImg.src = currentGallery[currentIndex];
        lbCaption.textContent = 'Image ' + (currentIndex + 1) + ' of ' + currentGallery.length;
    }
    function showNext() {
        if (!currentGallery.length) return;
        currentIndex = (currentIndex + 1) % currentGallery.length;
        lbImg.src = currentGallery[currentIndex];
        lbCaption.textContent = 'Image ' + (currentIndex + 1) + ' of ' + currentGallery.length;
    }

    function wireThumbnailClicks() {
        document.querySelectorAll('.report-card').forEach(card => {
            card.addEventListener('click', function (ev) {
                const t = ev.target;
                if (!t) return;
                const isThumb = t.classList && (t.classList.contains('thumb') || t.classList.contains('evidence-image'));
                if (!isThumb) return;
                const imgs = Array.from(card.querySelectorAll('.evidence-image, .thumb')).map(i => i.src).filter(Boolean);
                if (imgs.length) {
                    const idx = imgs.indexOf(t.src || t.getAttribute('src'));
                    showLightbox(imgs, (idx === -1 ? 0 : idx));
                    return;
                }
                // fallback to script payload
                const payloadScript = card.querySelector('script[type="application/json"][data-report-images-for]');
                if (payloadScript) {
                    try {
                        const parsed = JSON.parse(payloadScript.textContent || '[]');
                        const arr = Array.isArray(parsed) ? parsed : (typeof parsed === 'string' ? parsed.split(/[\r\n,]+/) : []);
                        const imgs2 = arr.map(normalizeUrl).filter(u => IMG_EXT_RE.test(u));
                        if (imgs2.length) {
                            const idx = imgs2.indexOf(t.src || t.getAttribute('src'));
                            showLightbox(imgs2, Math.max(0, idx));
                        }
                    } catch (e) {}
                }
            });
        });
    }

    // initialization
    function init() {
        try {
            gatherAndInjectAll();
            wireThumbnailClicks();
            wireCopyButtons(document);
            console.info('image+media-fixer: initialized');
        } catch (e) {
            console.error('init error', e);
        }
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else setTimeout(init, 10);

    // expose manual hooks
    window.__image_media_fixer = {
        run: init,
        gather: gatherAndInjectAll,
        wireCopyButtons
    };

})();
</script>

<!-- Pending -> Approve state helper: populate hidden "state" input & keep data-state consistent -->
<script>
(function(){
  'use strict';

  const STATES = [
    {name:'Alabama', abbr:'AL'},{name:'Alaska', abbr:'AK'},{name:'Arizona', abbr:'AZ'},{name:'Arkansas', abbr:'AR'},
    {name:'California', abbr:'CA'},{name:'Colorado', abbr:'CO'},{name:'Connecticut', abbr:'CT'},{name:'Delaware', abbr:'DE'},
    {name:'Florida', abbr:'FL'},{name:'Georgia', abbr:'GA'},{name:'Hawaii', abbr:'HI'},{name:'Idaho', abbr:'ID'},
    {name:'Illinois', abbr:'IL'},{name:'Indiana', abbr:'IN'},{name:'Iowa', abbr:'IA'},{name:'Kansas', abbr:'KS'},
    {name:'Kentucky', abbr:'KY'},{name:'Louisiana', abbr:'LA'},{name:'Maine', abbr:'ME'},{name:'Maryland', abbr:'MD'},
    {name:'Massachusetts', abbr:'MA'},{name:'Michigan', abbr:'MI'},{name:'Minnesota', abbr:'MN'},{name:'Mississippi', abbr:'MS'},
    {name:'Missouri', abbr:'MO'},{name:'Montana', abbr:'MT'},{name:'Nebraska', abbr:'NE'},{name:'Nevada', abbr:'NV'},
    {name:'New Hampshire', abbr:'NH'},{name:'New Jersey', abbr:'NJ'},{name:'New Mexico', abbr:'NM'},{name:'New York', abbr:'NY'},
    {name:'North Carolina', abbr:'NC'},{name:'North Dakota', abbr:'ND'},{name:'Ohio', abbr:'OH'},{name:'Oklahoma', abbr:'OK'},
    {name:'Oregon', abbr:'OR'},{name:'Pennsylvania', abbr:'PA'},{name:'Rhode Island', abbr:'RI'},{name:'South Carolina', abbr:'SC'},
    {name:'South Dakota', abbr:'SD'},{name:'Tennessee', abbr:'TN'},{name:'Texas', abbr:'TX'},{name:'Utah', abbr:'UT'},
    {name:'Vermont', abbr:'VT'},{name:'Virginia', abbr:'VA'},{name:'Washington', abbr:'WA'},{name:'West Virginia', abbr:'WV'},
    {name:'Wisconsin', abbr:'WI'},{name:'Wyoming', abbr:'WY'}
  ];

  function parseStateFromLocation(loc) {
    if (!loc) return null;
    const s = ('' + loc).replace(/\s+/g, ' ').trim();
    const lower = s.toLowerCase();

    // full name match first
    for (let st of STATES) {
      if (lower.includes(st.name.toLowerCase())) return {abbr: st.abbr, name: st.name};
    }
    // then try 2-letter abbr token
    for (let st of STATES) {
      const re = new RegExp('\\b' + st.abbr + '\\b', 'i');
      if (re.test(s)) return {abbr: st.abbr, name: st.name};
    }
    return null;
  }

  function populateApproveStateInputs() {
    document.querySelectorAll('.report-card').forEach(card => {
      try {
        // if server already populated data-state, prefer that
        let state = (card.getAttribute('data-state') || '').trim();
        const loc = (card.getAttribute('data-location') || '').trim();

        if (!state && loc) {
          const parsed = parseStateFromLocation(loc);
          if (parsed && parsed.abbr) state = parsed.abbr;
        }

        // set the data-state attribute so front-end filtering sees it consistently
        if (state) card.setAttribute('data-state', state.toUpperCase());
        else card.setAttribute('data-state', '');

        // populate hidden input in the approve form for this card (if present)
        const approveForm = card.querySelector('form.approve-form');
        if (approveForm) {
          const input = approveForm.querySelector('input.approve-state-input');
          if (input) input.value = state || '';
        }
      } catch (e) {
        console.warn('populateApproveStateInputs error', e);
      }
    });
  }

  // Ensure the hidden input is set again just before form submit (defensive)
  function wireApproveFormSubmitGuards() {
    document.querySelectorAll('form.approve-form').forEach(form => {
      // avoid adding duplicate handlers
      if (form.__approve_guarded) return;
      form.addEventListener('submit', function (ev) {
        try {
          const card = form.closest('.report-card');
          if (!card) return;
          let state = (card.getAttribute('data-state') || '').trim();
          const loc = (card.getAttribute('data-location') || '').trim();
          if (!state && loc) {
            const parsed = parseStateFromLocation(loc);
            if (parsed && parsed.abbr) state = parsed.abbr;
          }
          const input = form.querySelector('input.approve-state-input');
          if (input) input.value = state || '';
        } catch (e) {
          console.warn('approve submit guard error', e);
        }
      });
      form.__approve_guarded = true;
    });
  }

  // run on load and when new cards appear (defensive)
  function initPendingStateHelpers() {
    populateApproveStateInputs();
    wireApproveFormSubmitGuards();

    // observe DOM for dynamically added cards and populate them too
    const observer = new MutationObserver(mutations => {
      let found = false;
      for (const m of mutations) {
        if (m.addedNodes && m.addedNodes.length) {
          for (const n of m.addedNodes) {
            if (n.nodeType === 1 && n.matches('.report-card')) { found = true; break; }
          }
        }
        if (found) break;
      }
      if (found) {
        setTimeout(() => { populateApproveStateInputs(); wireApproveFormSubmitGuards(); }, 40);
      }
    });
    observer.observe(document.body, { childList: true, subtree: true });
    window.__pending_state_helper_observer = observer;
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initPendingStateHelpers);
  else setTimeout(initPendingStateHelpers, 10);

})();
</script>

</body>
</html>
