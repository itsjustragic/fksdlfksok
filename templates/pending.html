<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{{ page_title or "Reports - Charlie Kirk Memorial" }}</title>
    <link rel="icon" type="image/png" href="/static/logo.png">
    <link rel="stylesheet" href="/static/style.css">
    <style>
    /* lightbox / thumb styles (kept compact) */
    .lightbox-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; z-index:99999; padding:20px; }
    .lightbox-overlay.visible { display:flex; }
    .lightbox-container { position: relative; max-width:95%; max-height:95%; display:flex; align-items:center; justify-content:center; }
    .lightbox-image { max-width:100%; max-height:100%; border-radius:8px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
    .lightbox-close { position:absolute; top:8px; right:8px; background: rgba(0,0,0,0.6); color:#fff; border:none; font-size:20px; width:36px; height:36px; border-radius:6px; cursor:pointer; }
    .lightbox-arrow { position:absolute; top:50%; transform:translateY(-50%); background: rgba(0,0,0,0.5); color:#fff; border:none; font-size:28px; width:48px; height:72px; cursor:pointer; border-radius:6px; }
    .thumb, .evidence-image { cursor: zoom-in; max-width:100%; border-radius:4px; display:block; margin:8px 0; }
    .evidence-gallery { display:block; margin-top:8px; }
    .evidence-gallery img { max-width:180px; margin:6px; display:inline-block; vertical-align:top; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,0.35) }
    .evidence-link { display:inline-block; margin:6px 8px; padding:6px 10px; background:#222; color:#fff; border-radius:6px; text-decoration:none; }
    .report-evidence { margin-top:12px; }
    .report-card { background:#111; color:#ddd; padding:20px; border-radius:8px; box-shadow: 0 8px 28px rgba(0,0,0,0.45); margin:18px 0; }
    @media (max-width:720px){ .lightbox-arrow { width:42px; height:56px; font-size:22px; } }
    </style>
</head>
<body>
<header class="header">
    <div class="header-container">
        <h1>{{ header_title or "CHARLIE KIRK MEMORIAL" }}</h1>
        <nav><ul><li><a href="/">Home</a></li><li><a href="/report">Report</a></li><li><a href="/reports">Reports</a></li></ul></nav>
    </div>
</header>

<main class="reports-section">
    <div class="section-header">
        <h2>{{ section_title or "Pending Reports" }}</h2>
        <p class="subtitle">{{ subtitle or "Queued for review — approve or deny." }}</p>
    </div>

    <div class="reports-grid">
        {# Prevent duplicate rendering the same way you did before #}
        {% set _seen_sigs = [] %}
        {% for report in reports %}
            {% set sig = (report.full_name or '') ~ '|' ~ (report.platform or '') ~ '|' ~ (report.description or '') ~ '|' ~ (report.evidence_url or '') %}
            {% if sig in _seen_sigs %}
                {# skip duplicate rendering #}
            {% else %}
                {% set _seen_sigs = _seen_sigs + [sig] %}
                <article class="report-card" role="article" aria-labelledby="p-{{ report.id }}" data-id="{{ report.id }}" data-state="{{ report.state or '' }}" data-location="{{ report.location or '' }}">
                    <header class="report-card-header">
                        <h3 id="p-{{ report.id }}">{{ report.full_name or "Anonymous" }}</h3>
                        <div class="meta">
                            <span class="meta-item">{{ report.location or 'N/A' }}</span>
                            <span class="meta-sep">•</span>
                            <span class="meta-item">{{ report.platform or 'Unknown' }}</span>
                        </div>
                    </header>

                    <div class="report-card-body">
                        <p class="small"><strong>Category:</strong> {{ report.category or 'N/A' }}</p>
                        <p class="small"><strong>Occupation:</strong> {{ report.occupation or 'N/A' }}</p>
                        <p class="small"><strong>Employer:</strong> {{ report.employer or 'N/A' }}</p>
                        <p class="small"><strong>Address:</strong> {{ report.address or 'N/A' }}</p>
                        <p class="small"><strong>Phone:</strong> {{ report.phone or 'N/A' }}</p>
                        <p class="small"><strong>Their Emails:</strong> {{ report.employer_email or 'N/A' }}</p>
                        <p class="desc">{{ report.description }}</p>

                        <div class="report-evidence">
                            {# Keep your server-side evidence_url/img rendering (non-destructive) #}
                            {% if report.evidence_url %}
                                {% set ev2 = report.evidence_url %}
                                {% if ev2 is string %}
                                    {% set chk = ev2.strip() %}
                                    {% set candidate = chk.split('?')[0].split('#')[0].rstrip('/') %}
                                    {% set ext = candidate.rsplit('.',1)[-1]|lower if '.' in candidate else '' %}
                                    {% if ext in ['jpg','jpeg','png','gif','webp','bmp','svg'] %}
                                        <img src="{{ report.evidence_url }}" alt="Evidence" class="evidence-image" loading="lazy">
                                    {% else %}
                                        <a href="{{ report.evidence_url }}" class="evidence-link" target="_blank" rel="noopener noreferrer">View evidence</a>
                                    {% endif %}
                                {% endif %}
                            {% endif %}

                            {# If the server produced any image_list/gallery on its own, allow it to render. #}
                            {% if report.image_list %}
                                {% if report.image_list is iterable and report.image_list is not string %}
                                    <div class="evidence-gallery">
                                        {% for u in report.image_list %}
                                            <img src="{{ u }}" alt="Additional evidence" class="thumb" loading="lazy">
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    {# string fallback (comma or newline separated) #}
                                    <div class="evidence-gallery">
                                        {% for line in report.image_list.splitlines() %}
                                            {% for part in line.split(',') %}
                                                {% set v = part.strip() %}
                                                {% if v %}
                                                    <img src="{{ v }}" alt="Additional evidence" class="thumb" loading="lazy">
                                                {% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endif %}

                            {# Emit JSON payload (may be empty) — the client-side fixer will read it and also scan the card #}
                            <script type="application/json" data-report-images-for="{{ report.id }}">
                                {{ (report.images_only or report.image_list or report.image_urls or []) | tojson }}
                            </script>
                        </div>

                        <footer class="report-card-actions" style="margin-top:12px;">
                            {# Approve form now includes a hidden "state" field that we'll populate client-side #}
                            <form action="/approve/{{ report.id }}" method="post" class="action-form approve-form" style="display:inline-block;margin-right:8px;">
                                <input type="hidden" name="state" class="approve-state-input" value="{{ report.state or '' }}">
                                <button type="submit" class="admin-button small">Approve</button>
                            </form>
                            <form action="/deny/{{ report.id }}" method="post" class="action-form deny-form" style="display:inline-block;">
                                <button type="submit" class="deny-button small">Deny</button>
                            </form>
                        </footer>
                    </div>
                </article>
            {% endif %}
        {% endfor %}
    </div>
</main>

<!-- lightbox DOM (single shared instance) -->
<div id="lightbox" class="lightbox-overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="lightbox-container">
        <button class="lightbox-arrow left" aria-label="Previous image">&larr;</button>
        <img src="" alt="" class="lightbox-image" id="lightbox-img">
        <button class="lightbox-arrow right" aria-label="Next image">&rarr;</button>
        <button class="lightbox-close" aria-label="Close lightbox">&times;</button>
    </div>
    <div class="lightbox-caption" id="lightbox-caption"></div>
</div>

<script>
/* Full client-side fixer + gallery injector + lightbox wiring.
   Purpose: show the image URLs you submitted even if server-side parsing missed them.
*/
(function () {
    'use strict';

    const IMG_EXT_RE = /\.(jpg|jpeg|png|gif|webp|bmp|svg)(?:[?#].*)?$/i;
    const HTTP_IMG_TOKEN_RE = /\bhttps?:\/\/[^\s'"]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)(?:[?#][^\s'"]*)?/gi;

    function normalizeUrl(u) {
        if (!u) return '';
        u = ('' + u).trim();
        if (u.startsWith('<') && u.endsWith('>')) u = u.slice(1, -1).trim();
        if ((u.startsWith('"') && u.endsWith('"')) || (u.startsWith("'") && u.endsWith("'"))) u = u.slice(1, -1);
        return u.trim();
    }

    function extractFromScriptPayload(card) {
        const script = card.querySelector('script[type="application/json"][data-report-images-for]');
        if (!script) return [];
        try {
            const raw = script.textContent || '[]';
            const arr = JSON.parse(raw);
            if (Array.isArray(arr)) return arr.map(normalizeUrl).filter(Boolean);
            // could be string or object
            if (typeof arr === 'string') {
                return arr.split(/[\r\n,]+/).map(normalizeUrl).filter(Boolean);
            }
            return [];
        } catch (e) {
            console.warn('image-fixer: JSON parse failed for payload in', card, e);
            // fallback: attempt to find http tokens inside script text
            const txt = script.textContent || '';
            const found = txt.match(HTTP_IMG_TOKEN_RE) || [];
            return found.map(normalizeUrl);
        }
    }

    function extractFromDOM(card) {
        const found = new Set();
        // existing images
        Array.from(card.querySelectorAll('img')).forEach(img => {
            if (img.src) found.add(normalizeUrl(img.src));
        });
        // links (href)
        Array.from(card.querySelectorAll('a')).forEach(a => {
            const href = a.getAttribute('href') || '';
            if (IMG_EXT_RE.test(href)) found.add(normalizeUrl(href));
        });
        // data attributes or hidden spans - scan text for http image tokens
        const text = card.innerText || card.textContent || '';
        let match;
        while ((match = HTTP_IMG_TOKEN_RE.exec(text)) !== null) {
            found.add(normalizeUrl(match[0]));
        }
        return Array.from(found);
    }

    function filterImageExts(arr) {
        return arr.map(normalizeUrl).filter(u => IMG_EXT_RE.test(u));
    }

    function buildGallery(card, urls) {
        if (!urls || !urls.length) return [];
        let gallery = card.querySelector('.evidence-gallery');
        let created = false;
        if (!gallery) {
            gallery = document.createElement('div');
            gallery.className = 'evidence-gallery';
            created = true;
        }
        const existing = new Set(Array.from(gallery.querySelectorAll('img')).map(i => i.src));
        const injected = [];
        urls.forEach(u => {
            if (!u) return;
            if (existing.has(u)) return;
            try {
                const img = document.createElement('img');
                img.src = u;
                img.alt = 'Additional evidence';
                img.loading = 'lazy';
                img.className = 'thumb';
                img.setAttribute('data-auto-injected', '1');
                gallery.appendChild(img);
                injected.push(u);
                existing.add(u);
            } catch (e) {
                console.warn('image-fixer: failed to create img for', u, e);
            }
        });
        if (created) {
            // Append to the evidence container. If it doesn't exist, append to card body.
            const evidenceContainer = card.querySelector('.report-evidence') || card.querySelector('.report-card-body') || card;
            evidenceContainer.appendChild(gallery);
        }
        return injected;
    }

    function gatherAndInjectAll() {
        const cards = Array.from(document.querySelectorAll('.report-card'));
        console.info('image-fixer: processing', cards.length, 'report cards');
        cards.forEach(card => {
            try {
                const id = card.getAttribute('data-id') || (card.querySelector('[id^="p-"]') && card.querySelector('[id^="p-"]').id.replace('p-','')) || 'unknown';
                // get urls from payload first
                const fromScript = extractFromScriptPayload(card);
                const fromDom = extractFromDOM(card);
                const combined = Array.from(new Set(Array.prototype.concat(fromScript, fromDom)));
                const images = filterImageExts(combined);
                if (!images.length) {
                    console.debug('image-fixer:', id, 'no candidate images found (script/dom).');
                    return;
                }
                console.info('image-fixer:', id, 'found images:', images);
                const injected = buildGallery(card, images);
                if (injected.length) {
                    console.info('image-fixer:', id, 'injected', injected.length, 'images');
                } else {
                    console.debug('image-fixer:', id, 'no images injected (maybe already present)');
                }
            } catch (e) {
                console.error('image-fixer: error processing card', card, e);
            }
        });
    }

    /* Lightbox: reuse a single overlay element (exists in DOM) and wire thumbnails */
    const lightbox = document.getElementById('lightbox');
    const lbImg = document.getElementById('lightbox-img');
    const lbCaption = document.getElementById('lightbox-caption');
    const btnPrev = document.querySelector('.lightbox-arrow.left');
    const btnNext = document.querySelector('.lightbox-arrow.right');
    const btnClose = document.querySelector('.lightbox-close');

    let currentGallery = [];
    let currentIndex = 0;

    function showLightbox(gallery, index) {
        if (!gallery || !gallery.length) return;
        currentGallery = gallery.slice();
        currentIndex = Math.max(0, Math.min(index || 0, currentGallery.length - 1));
        lbImg.src = currentGallery[currentIndex];
        lbImg.alt = 'Image ' + (currentIndex + 1) + ' of ' + currentGallery.length;
        lbCaption.textContent = lbImg.alt;
        lightbox.classList.add('visible');
        lightbox.setAttribute('aria-hidden', 'false');
    }
    function hideLightbox() {
        lightbox.classList.remove('visible');
        lightbox.setAttribute('aria-hidden', 'true');
        lbImg.src = '';
        currentGallery = [];
        currentIndex = 0;
    }
    function showPrev() {
        if (!currentGallery.length) return;
        currentIndex = (currentIndex - 1 + currentGallery.length) % currentGallery.length;
        lbImg.src = currentGallery[currentIndex];
        lbCaption.textContent = 'Image ' + (currentIndex + 1) + ' of ' + currentGallery.length;
    }
    function showNext() {
        if (!currentGallery.length) return;
        currentIndex = (currentIndex + 1) % currentGallery.length;
        lbImg.src = currentGallery[currentIndex];
        lbCaption.textContent = 'Image ' + (currentIndex + 1) + ' of ' + currentGallery.length;
    }

    function wireThumbnailClicks() {
        // When user clicks a thumb or evidence-image, open the lightbox with that card's gallery
        document.querySelectorAll('.report-card').forEach(card => {
            card.addEventListener('click', function (ev) {
                const t = ev.target;
                if (!t) return;
                const isThumb = t.classList && (t.classList.contains('thumb') || t.classList.contains('evidence-image'));
                if (!isThumb) return;
                // build gallery from imgs inside this card (in DOM order)
                const imgs = Array.from(card.querySelectorAll('.evidence-image, .thumb')).map(i => i.src).filter(Boolean);
                if (!imgs.length) {
                    // fallback to JSON payload
                    const payload = extractFromScriptPayload(card);
                    const imgs2 = filterImageExts(payload);
                    if (!imgs2.length) return;
                    const idx = imgs2.indexOf(t.src || t.getAttribute('src'));
                    showLightbox(imgs2, Math.max(0, idx));
                    return;
                }
                const idx = imgs.indexOf(t.src || t.getAttribute('src'));
                showLightbox(imgs, (idx === -1 ? 0 : idx));
            });
        });
    }

    // wire lightbox controls
    if (btnPrev) btnPrev.addEventListener('click', showPrev);
    if (btnNext) btnNext.addEventListener('click', showNext);
    if (btnClose) btnClose.addEventListener('click', hideLightbox);
    lightbox.addEventListener('click', function (ev) { if (ev.target === lightbox || ev.target === lbCaption) hideLightbox(); });
    document.addEventListener('keydown', function (ev) {
        if (!lightbox.classList.contains('visible')) return;
        if (ev.key === 'Escape') hideLightbox();
        if (ev.key === 'ArrowLeft') showPrev();
        if (ev.key === 'ArrowRight') showNext();
    });

    // Run on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function () {
        try {
            gatherAndInjectAll();
            wireThumbnailClicks();
            console.info('image-fixer: initialized');
        } catch (e) {
            console.error('image-fixer: initialization error', e);
        }
    });

    // Also expose a manual hook for testing
    window.__image_fixer = {
        run: function(){ gatherAndInjectAll(); wireThumbnailClicks(); },
        findImageTokens: function(text){ return (text||'').match(HTTP_IMG_TOKEN_RE) || []; }
    };

})();
</script>

<!-- Pending -> Approve state helper: populate hidden "state" input & keep data-state consistent -->
<script>
(function(){
  'use strict';

  const STATES = [
    {name:'Alabama', abbr:'AL'},{name:'Alaska', abbr:'AK'},{name:'Arizona', abbr:'AZ'},{name:'Arkansas', abbr:'AR'},
    {name:'California', abbr:'CA'},{name:'Colorado', abbr:'CO'},{name:'Connecticut', abbr:'CT'},{name:'Delaware', abbr:'DE'},
    {name:'Florida', abbr:'FL'},{name:'Georgia', abbr:'GA'},{name:'Hawaii', abbr:'HI'},{name:'Idaho', abbr:'ID'},
    {name:'Illinois', abbr:'IL'},{name:'Indiana', abbr:'IN'},{name:'Iowa', abbr:'IA'},{name:'Kansas', abbr:'KS'},
    {name:'Kentucky', abbr:'KY'},{name:'Louisiana', abbr:'LA'},{name:'Maine', abbr:'ME'},{name:'Maryland', abbr:'MD'},
    {name:'Massachusetts', abbr:'MA'},{name:'Michigan', abbr:'MI'},{name:'Minnesota', abbr:'MN'},{name:'Mississippi', abbr:'MS'},
    {name:'Missouri', abbr:'MO'},{name:'Montana', abbr:'MT'},{name:'Nebraska', abbr:'NE'},{name:'Nevada', abbr:'NV'},
    {name:'New Hampshire', abbr:'NH'},{name:'New Jersey', abbr:'NJ'},{name:'New Mexico', abbr:'NM'},{name:'New York', abbr:'NY'},
    {name:'North Carolina', abbr:'NC'},{name:'North Dakota', abbr:'ND'},{name:'Ohio', abbr:'OH'},{name:'Oklahoma', abbr:'OK'},
    {name:'Oregon', abbr:'OR'},{name:'Pennsylvania', abbr:'PA'},{name:'Rhode Island', abbr:'RI'},{name:'South Carolina', abbr:'SC'},
    {name:'South Dakota', abbr:'SD'},{name:'Tennessee', abbr:'TN'},{name:'Texas', abbr:'TX'},{name:'Utah', abbr:'UT'},
    {name:'Vermont', abbr:'VT'},{name:'Virginia', abbr:'VA'},{name:'Washington', abbr:'WA'},{name:'West Virginia', abbr:'WV'},
    {name:'Wisconsin', abbr:'WI'},{name:'Wyoming', abbr:'WY'}
  ];

  function parseStateFromLocation(loc) {
    if (!loc) return null;
    const s = ('' + loc).replace(/\s+/g, ' ').trim();
    const lower = s.toLowerCase();

    // full name match first
    for (let st of STATES) {
      if (lower.includes(st.name.toLowerCase())) return {abbr: st.abbr, name: st.name};
    }
    // then try 2-letter abbr token
    for (let st of STATES) {
      const re = new RegExp('\\b' + st.abbr + '\\b', 'i');
      if (re.test(s)) return {abbr: st.abbr, name: st.name};
    }
    return null;
  }

  function populateApproveStateInputs() {
    document.querySelectorAll('.report-card').forEach(card => {
      try {
        // if server already populated data-state, prefer that
        let state = (card.getAttribute('data-state') || '').trim();
        const loc = (card.getAttribute('data-location') || '').trim();

        if (!state && loc) {
          const parsed = parseStateFromLocation(loc);
          if (parsed && parsed.abbr) state = parsed.abbr;
        }

        // set the data-state attribute so front-end filtering sees it consistently
        if (state) card.setAttribute('data-state', state.toUpperCase());
        else card.setAttribute('data-state', '');

        // populate hidden input in the approve form for this card (if present)
        const approveForm = card.querySelector('form.approve-form');
        if (approveForm) {
          const input = approveForm.querySelector('input.approve-state-input');
          if (input) input.value = state || '';
        }
      } catch (e) {
        console.warn('populateApproveStateInputs error', e);
      }
    });
  }

  // Ensure the hidden input is set again just before form submit (defensive)
  function wireApproveFormSubmitGuards() {
    document.querySelectorAll('form.approve-form').forEach(form => {
      // avoid adding duplicate handlers
      if (form.__approve_guarded) return;
      form.addEventListener('submit', function (ev) {
        try {
          const card = form.closest('.report-card');
          if (!card) return;
          let state = (card.getAttribute('data-state') || '').trim();
          const loc = (card.getAttribute('data-location') || '').trim();
          if (!state && loc) {
            const parsed = parseStateFromLocation(loc);
            if (parsed && parsed.abbr) state = parsed.abbr;
          }
          const input = form.querySelector('input.approve-state-input');
          if (input) input.value = state || '';
        } catch (e) {
          console.warn('approve submit guard error', e);
        }
      });
      form.__approve_guarded = true;
    });
  }

  // run on load and when new cards appear (defensive)
  function initPendingStateHelpers() {
    populateApproveStateInputs();
    wireApproveFormSubmitGuards();

    // observe DOM for dynamically added cards and populate them too
    const observer = new MutationObserver(mutations => {
      let found = false;
      for (const m of mutations) {
        if (m.addedNodes && m.addedNodes.length) {
          for (const n of m.addedNodes) {
            if (n.nodeType === 1 && n.matches('.report-card')) { found = true; break; }
          }
        }
        if (found) break;
      }
      if (found) {
        setTimeout(() => { populateApproveStateInputs(); wireApproveFormSubmitGuards(); }, 40);
      }
    });
    observer.observe(document.body, { childList: true, subtree: true });
    window.__pending_state_helper_observer = observer;
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initPendingStateHelpers);
  else setTimeout(initPendingStateHelpers, 10);

})();
</script>

</body>
</html>
