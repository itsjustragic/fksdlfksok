<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Report Evil - Charlie Kirk Memorial</title>
    <link rel="icon" type="image/png" href="/static/logo.png">    
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header class="header">
        <div class="header-container">
            <h1>WE ARE CHARLIE KIRK</h1>
            <nav>
                <ul>
                    <li><a href="/">Home</a></li>
                    <li><a href="/report">Report</a></li>
                    <li><a href="/reports">Reports</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <section class="report-section">
        <div class="report-header">
            <h2>REPORT EVIL</h2>
            <p>Submit evidence of individuals who celebrated Charlie Kirk's death. All submissions are confidential and reviewed by our team.</p>
        </div>
        <form id="report-form">
            <h3>SUBJECT INFORMATION</h3>
            <label>Full Name *</label>
            <input type="text" name="full_name" required>
            <label>Location (optional)</label>
            <input type="text" name="location" placeholder="City, State/Country">
            <label>Occupation</label>
            <input type="text" name="occupation">
            <label>Employer</label>
            <input type="text" name="employer" required>
            <label>Address (optional)</label>
            <input type="text" name="address">
            <label>Their Emails (optional)</label>
            <input type="text" name="employer_email">            
            <label>Phone Number (optional)</label>
            <input type="tel" name="phone">

            <h3>INCIDENT DETAILS</h3>
            <label>Category *</label>
            <select name="category" required>
                <option>Direct Celebration of Death</option>
                <option>Mocking Family/Friends</option>
                <option>Calls for More Violence</option>
                <option>Celebrating Memes</option>
                <option>Threatening Similar Actions</option>
                <option>Other</option>
            </select>
            <label>Platform *</label>
            <select name="platform" required>
                <option>X/Twitter/X</option>
                <option>Facebook</option>
                <option>Instagram</option>
                <option>Tik Tok</option>
                <option>YouTube</option>
                <option>Other</option>
            </select>
            <label>Evidence URL *</label>
            <input type="url" name="evidence_url" required>
            <label>Image URLs (optional, one per line)</label>
            <textarea name="image_urls"></textarea>
            <label>Description *</label>
            <textarea name="description" required></textarea>

            <button id="report-submit" type="submit">Submit</button>
        </form>
    </section>

    <script src="/static/script.js"></script>

    <!--
      NOTE: original inline submit logic kept but enhanced to:
        - Prevent double-submit (global guard + disable button)
        - Normalize image_urls to an array (one URL per line)
        - Map employer_email/email consistently
        - Do not require "location" (keep as optional)
      I did not remove any original pieces — only added safe normalization and guards.
    -->
    <script>
        (function () {
            const form = document.getElementById('report-form');
            const submitBtn = document.getElementById('report-submit');

            // global guard to prevent double-post from multiple handlers
            window.__reportSubmitting = window.__reportSubmitting || false;

            if (form) {
                form.addEventListener('submit', async (event) => {
                    event.preventDefault();

                    // If another submission is in progress, bail out.
                    if (window.__reportSubmitting) {
                        console.warn('Submission already in progress, ignoring duplicate click.');
                        return;
                    }
                    window.__reportSubmitting = true;
                    if (submitBtn) submitBtn.disabled = true;

                    try {
                        const formData = new FormData(event.target);
                        const data = {};

                        // original behavior: copy all form fields
                        formData.forEach((value, key) => {
                            data[key] = value;
                        });

                        // --- NEW: normalize image_urls so it's ALWAYS an array of non-empty trimmed strings
                        if (data.image_urls && typeof data.image_urls === 'string') {
                            const arr = data.image_urls
                                .split(/\r?\n/)
                                .map(s => s.trim())
                                .filter(Boolean);
                            data.image_urls = arr;
                        } else if (!data.image_urls) {
                            data.image_urls = [];
                        }

                        // --- NEW: ensure we send employer_email as well as email for compatibility
                        // if form used employer_email, but some server code expects "email"
                        if (!data.email && data.employer_email) {
                            data.email = data.employer_email;
                        }
                        if (!data.employer_email && data.email) {
                            data.employer_email = data.email;
                        }

                        // Basic client-side required check to avoid obvious empty submissions
                        // NOTE: location is optional in the form; don't require it here.
                        if (!data.full_name || !data.evidence_url || !data.description || !data.category || !data.platform || !data.employer) {
                            alert('Please fill in all required fields.');
                            return;
                        }

                        // send JSON payload
                        const response = await fetch('/submit_report', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(data),
                        });

                        if (response.ok) {
                            // attempt to read any JSON message
                            let dataText = '';
                            try {
                                const json = await response.json();
                                dataText = json.message ? ` — ${json.message}` : '';
                                // If server suggests a redirect, honor it
                                if (json.redirect) {
                                    window.location.href = json.redirect;
                                    return;
                                }
                            } catch (err) {
                                // not JSON or empty, ignore
                            }
                            alert('Report submitted successfully!' + dataText);
                            form.reset();
                            console.log('Report submitted (inline handler):', data);
                        } else {
                            console.error('Submission failed:', await response.text());
                            alert('Submission failed: ' + response.status);
                        }
                    } catch (error) {
                        console.error('Error submitting report:', error);
                        alert('Error submitting report: ' + (error && error.message ? error.message : String(error)));
                    } finally {
                        window.__reportSubmitting = false;
                        if (submitBtn) submitBtn.disabled = false;
                    }
                });
            }
        })();
    </script>
</body>
</html>
