<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Reports - Charlie Kirk Memorial</title>
    <link rel="icon" type="image/png" href="/static/logo.png">
    <link rel="stylesheet" href="/static/style.css">
    <style>
    /* lightbox / thumb styles */
    .lightbox-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; z-index:99999; padding:20px; }
    .lightbox-overlay.visible { display:flex; }
    .lightbox-container { position: relative; max-width:95%; max-height:95%; display:flex; align-items:center; justify-content:center; overflow: visible; }
    .lightbox-image { max-width:100%; max-height:100%; border-radius:8px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); display:block; }
    .lightbox-close { position:absolute; top:8px; right:8px; background: rgba(0,0,0,0.6); color:#fff; border:none; font-size:20px; width:36px; height:36px; border-radius:6px; cursor:pointer }
    .lightbox-arrow { position:absolute; top:50%; transform:translateY(-50%); background: rgba(0,0,0,0.55); color:#fff; border:none; font-size:28px; width:48px; height:72px; cursor:pointer; border-radius:6px; display:none; align-items:center; justify-content:center; }
    .lightbox-arrow.left { left: calc(-1 * (48px + 8px)); }   /* slightly outside left */
    .lightbox-arrow.right { right: calc(-1 * (48px + 8px)); }  /* slightly outside right */
    .thumb, .evidence-image { cursor: zoom-in; max-width:100%; border-radius:4px; display:block; margin:8px 0; }
    .evidence-gallery { display:block; margin-top:8px; }
    .evidence-gallery img { max-width:180px; margin:6px; display:inline-block; vertical-align:top; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,0.35); }
    .evidence-link { display:inline-block; margin:6px 8px; padding:6px 10px; background:#222; color:#fff; border-radius:6px; text-decoration:none; }
    .report-card { background:#111; color:#ddd; padding:20px; border-radius:8px; box-shadow: 0 8px 28px rgba(0,0,0,0.45); margin:18px 0; }
    .report-evidence { margin-top:12px; }
    .lightbox-caption { margin-top:10px; color:#fff; font-size:0.95rem; text-align:center; max-width:90%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    @media (max-width:720px){ .lightbox-arrow { width:42px; height:56px; font-size:22px; left: calc(-1 * (42px + 6px)); right: calc(-1 * (42px + 6px)); } }
    </style>
</head>
<body>
<header class="header">
    <div class="header-container">
        <h1>WE ARE CHARLIE KIRK</h1>
        <nav>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/report">Report</a></li>
                <li><a href="/reports">Reports</a></li>
            </ul>
        </nav>
    </div>
</header>

<main class="reports-section">
    <div class="section-header">
        <h2>Verified Reports</h2>
        <p class="subtitle">Verified reports made public.</p>
    </div>

    <!-- FILTER CONTROLS (unchanged) -->
    <div class="reports-controls" aria-label="Filter reports">
        <div class="controls-inner">
            <label for="reports-search" class="visually-hidden">Search reports</label>
            <input id="reports-search" type="search" placeholder="Search by name, description, employer, platform..." aria-label="Search reports">
            <label for="reports-state" class="visually-hidden">Filter by state</label>
            <select id="reports-state" aria-label="Filter reports by state">
                <option value="ALL">All States</option>
                <!-- states list -->
            </select>
        </div>
        <div id="no-results" class="no-results" style="display:none;">No reports match your filter.</div>
    </div>

    <div class="reports-grid" id="reports-grid">
        {% set _seen_sigs = [] %}
        {% for report in reports %}
            {% set sig = (report.full_name or '') ~ '|' ~ (report.platform or '') ~ '|' ~ (report.description or '') ~ '|' ~ (report.evidence_url or '') %}
            {% if sig in _seen_sigs %}
            {% else %}
                {% set _seen_sigs = _seen_sigs + [sig] %}
                <article class="report-card" role="article" aria-labelledby="r-{{ report.id }}" data-id="{{ report.id }}">
                    <header class="report-card-header">
                        <h3 id="r-{{ report.id }}">{{ report.full_name or "Anonymous" }}</h3>
                        <div class="meta">
                            <span class="meta-item">{{ report.location or 'N/A' }}</span>
                            <span class="meta-sep">•</span>
                            <span class="meta-item">{{ report.platform or 'Unknown' }}</span>
                        </div>
                    </header>

                    <div class="report-card-body">
                        <p class="small"><strong>Category:</strong> {{ report.category or 'N/A' }}</p>
                        <p class="small"><strong>Occupation:</strong> {{ report.occupation or 'N/A' }}</p>
                        <p class="small"><strong>Employer:</strong> {{ report.employer or 'N/A' }}</p>
                        <p class="small"><strong>Address:</strong> {{ report.address or 'N/A' }}</p>
                        <p class="small"><strong>Phone:</strong> {{ report.phone or 'N/A' }}</p>
                        <p class="small"><strong>Their Emails:</strong> {{ report.employer_email or 'N/A' }}</p>
                        <p class="desc">{{ report.description }}</p>

                        <div class="report-evidence">
                            {# server-side attempt to render evidence_url if image #}
                            {% if report.evidence_url %}
                                {% set ev2 = report.evidence_url %}
                                {% if ev2 is string %}
                                    {% set chk = ev2.strip() %}
                                    {% set candidate = chk.split('?')[0].split('#')[0].rstrip('/') %}
                                    {% set ext = candidate.rsplit('.',1)[-1]|lower if '.' in candidate else '' %}
                                    {% if ext in ['jpg','jpeg','png','gif','webp','bmp','svg'] %}
                                        <img src="{{ report.evidence_url }}" alt="Evidence" class="evidence-image" loading="lazy">
                                    {% else %}
                                        <a href="{{ report.evidence_url }}" class="evidence-link" target="_blank" rel="noopener noreferrer">View evidence</a>
                                    {% endif %}
                                {% endif %}
                            {% endif %}

                            {# server-side robust image_list construction (unchanged) #}
                            {% set image_list = [] %}
                            {% if report.image_urls %}
                                {% if report.image_urls is string %}
                                    {% set raw = report.image_urls.strip() %}
                                    {% if raw.startswith('[') and raw.endswith(']') %}
                                        {% set inner = raw[1:-1] %}
                                        {% for part in inner.split(',') %}
                                            {% set p = part.strip().strip('"').strip("'") %}
                                            {% if p %}{% set image_list = image_list + [p] %}{% endif %}
                                        {% endfor %}
                                    {% else %}
                                        {% for line in report.image_urls.splitlines() %}
                                            {% for part in line.split(',') %}
                                                {% set u = part.strip() %}
                                                {% if u.startswith('<') and u.endswith('>') %}{% set u = u[1:-1].strip() %}{% endif %}
                                                {% set u = u.strip().strip('"').strip("'") %}
                                                {% if u %}{% set image_list = image_list + [u] %}{% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                    {% endif %}
                                {% else %}
                                    {% for item in report.image_urls %}{% if item %}{% set u = item %}{% if u is string %}{% set u = u.strip() %}{% if u.startswith('<') and u.endswith('>') %}{% set u = u[1:-1].strip() %}{% endif %}{% set u = u.strip().strip('"').strip("'") %}{% endif %}{% if u %}{% set image_list = image_list + [u] %}{% endif %}{% endif %}{% endfor %}
                                {% endif %}
                            {% endif %}

                            {% for altkey in ['image_list','images_only','images','imageUrls'] %}
                                {% if report[altkey] is defined and report[altkey] %}
                                    {% if report[altkey] is string %}
                                        {% for line in report[altkey].splitlines() %}
                                            {% for part in line.split(',') %}
                                                {% set v = part.strip() %}
                                                {% if v %}{% set image_list = image_list + [v] %}{% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                    {% else %}
                                        {% for item in report[altkey] %}{% if item %}{% set image_list = image_list + [item] %}{% endif %}{% endfor %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% set seen = [] %}
                            {% set normalized = [] %}
                            {% for u in image_list %}
                                {% if u is string %}
                                    {% set uu = u.strip() %}
                                    {% if uu.startswith('<') and uu.endswith('>') %}{% set uu = uu[1:-1].strip() %}{% endif %}
                                    {% set uu = uu.strip().strip('"').strip("'") %}
                                    {% if uu and uu not in seen %}{% set seen = seen + [uu] %}{% set normalized = normalized + [uu] %}{% endif %}
                                {% endif %}
                            {% endfor %}
                            {% set image_list = normalized %}

                            {% set img_exts = ['jpg','jpeg','png','gif','webp','bmp','svg'] %}
                            {% set images_only = [] %}
                            {% if report.evidence_url %}
                                {% set ev = report.evidence_url %}
                                {% if ev is string %}
                                    {% set ev2 = ev.strip() %}
                                    {% if ev2.startswith('<') and ev2.endswith('>') %}{% set ev2 = ev2[1:-1].strip() %}{% endif %}
                                    {% set candidate = ev2.split('?')[0].split('#')[0].rstrip('/') %}
                                    {% set ext = candidate.rsplit('.',1)[-1]|lower if '.' in candidate else '' %}
                                    {% if ext in img_exts %}{% set images_only = images_only + [ev] %}{% endif %}
                                {% endif %}
                            {% endif %}
                            {% for url in image_list %}
                                {% set candidate = url.split('?')[0].split('#')[0].rstrip('/') %}
                                {% set ext = candidate.rsplit('.',1)[-1]|lower if '.' in candidate else '' %}
                                {% if ext in img_exts and (url not in images_only) %}{% set images_only = images_only + [url] %}{% endif %}
                            {% endfor %}

                            {% if image_list and image_list|length > 0 %}
                                <div class="evidence-gallery">
                                    {% for url in image_list %}
                                        {% set candidate = url.split('?')[0].split('#')[0].rstrip('/') %}
                                        {% set ext = candidate.rsplit('.',1)[-1]|lower if '.' in candidate else '' %}
                                        {% if ext in img_exts %}
                                            <img src="{{ url }}" alt="Additional evidence" class="thumb" loading="lazy">
                                        {% else %}
                                            <a href="{{ url }}" class="evidence-link" target="_blank" rel="noopener noreferrer">View link</a>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <script type="application/json" data-report-images-for="{{ report.id }}">
                            {{ (images_only or []) | tojson }}
                        </script>

                    </div>
                </article>
            {% endif %}
        {% endfor %}
    </div>
</main>

<!-- Lightbox DOM -->
<div id="lightbox" class="lightbox-overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="lightbox-container">
        <button class="lightbox-arrow left" aria-label="Previous image" id="lb-prev">&#x2190;</button>
        <img src="" alt="" class="lightbox-image" id="lightbox-img">
        <button class="lightbox-arrow right" aria-label="Next image" id="lb-next">&#x2192;</button>
        <button class="lightbox-close" aria-label="Close lightbox" id="lb-close">&times;</button>
    </div>
    <div class="lightbox-caption" id="lightbox-caption"></div>
</div>

<script>
/* --- patch: smarter injection + "View evidence" click-to-open --- */
(function(){
  'use strict';
  const IMG_EXT_RE = /\.(jpg|jpeg|png|gif|webp|bmp|svg)(?:[?#].*)?$/i;
  const HTTP_IMG_TOKEN_RE = /\bhttps?:\/\/[^\s'"]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)(?:[?#][^\s'"]*)?/gi;

  /* reuse/duplicate your normalize/parse/extract/inject functions (or if they already exist in the file, remove duplicates) */
  function normalizeUrl(u){
    if (!u || typeof u !== 'string') return '';
    u = u.trim();
    if ((u.startsWith('"') && u.endsWith('"')) || (u.startsWith("'") && u.endsWith("'"))) u = u.slice(1,-1).trim();
    if (u.startsWith('<') && u.endsWith('>')) u = u.slice(1,-1).trim();
    return u;
  }

  function parseJsonPayloadForId(id){
    const script = document.querySelector('script[type="application/json"][data-report-images-for="'+String(id)+'"]');
    if (!script) return [];
    const txt = script.textContent || '';
    try {
      const parsed = JSON.parse(txt);
      if (Array.isArray(parsed)) return parsed.map(normalizeUrl).filter(Boolean);
      if (typeof parsed === 'string') return parsed.split(/[\r\n,]+/).map(normalizeUrl).filter(Boolean);
      return [];
    } catch (e) {
      const found = txt.match(HTTP_IMG_TOKEN_RE) || [];
      return found.map(normalizeUrl);
    }
  }

  function extractFromDom(card){
    const found = new Set();
    Array.from(card.querySelectorAll('img')).forEach(img => { if (img.src) found.add(normalizeUrl(img.src)); });
    Array.from(card.querySelectorAll('a[href]')).forEach(a => {
      const href = a.getAttribute('href') || '';
      if (IMG_EXT_RE.test(href)) found.add(normalizeUrl(href));
      try { if (a.href && IMG_EXT_RE.test(a.href)) found.add(normalizeUrl(a.href)); } catch(e){}
    });
    const text = card.textContent || '';
    const tokens = text.match(HTTP_IMG_TOKEN_RE) || [];
    tokens.forEach(t => found.add(normalizeUrl(t)));
    return Array.from(found);
  }

  function ensureGallery(card){
    let g = card.querySelector('.evidence-gallery');
    if (!g) {
      g = document.createElement('div');
      g.className = 'evidence-gallery';
      const evidenceBlock = card.querySelector('.report-evidence') || card.querySelector('.report-card-body') || card;
      evidenceBlock.appendChild(g);
    }
    return g;
  }

  function injectImages(card, urls){
    if (!urls || !urls.length) return [];
    const gallery = ensureGallery(card);
    const existing = new Set(Array.from(gallery.querySelectorAll('img')).map(i => i.src));
    const injected = [];
    urls.forEach(u => {
      if (!u) return;
      const n = normalizeUrl(u);
      if (!IMG_EXT_RE.test(n)) return;
      if (existing.has(n)) return;
      const img = document.createElement('img');
      img.className = 'thumb';
      img.loading = 'lazy';
      img.alt = 'Additional evidence';
      img.src = n;
      img.setAttribute('data-auto-injected', '1');
      gallery.appendChild(img);
      injected.push(n);
      existing.add(n);
    });
    return injected;
  }

  /* lightbox wiring (very small; assumes lightbox HTML exists) */
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightbox-img');
  const caption = document.getElementById('lightbox-caption');
  const prevBtn = document.querySelector('.lightbox-arrow.left');
  const nextBtn = document.querySelector('.lightbox-arrow.right');
  const closeBtn = document.querySelector('.lightbox-close');

  let currentGallery = [];
  let currentIndex = 0;
  function openGallery(g, idx){
    currentGallery = g.slice();
    currentIndex = Math.max(0, Math.min(idx || 0, currentGallery.length - 1));
    lightboxImg.src = currentGallery[currentIndex];
    lightboxImg.alt = 'Image ' + (currentIndex + 1) + ' of ' + currentGallery.length;
    caption.textContent = lightboxImg.alt;
    lightbox.classList.add('visible');
    lightbox.setAttribute('aria-hidden','false');
    if (prevBtn && nextBtn) {
      if (currentGallery.length > 1) { prevBtn.style.display = 'flex'; nextBtn.style.display = 'flex'; } else { prevBtn.style.display='none'; nextBtn.style.display='none'; }
    }
  }
  function closeLightbox(){ if (!lightbox) return; lightbox.classList.remove('visible'); lightbox.setAttribute('aria-hidden','true'); lightboxImg.src = ''; currentGallery = []; currentIndex = 0; }
  function prev(){ if (currentGallery.length<=1) return; currentIndex=(currentIndex-1+currentGallery.length)%currentGallery.length; lightboxImg.src=currentGallery[currentIndex]; caption.textContent = lightboxImg.alt = 'Image ' + (currentIndex+1) + ' of ' + currentGallery.length; }
  function next(){ if (currentGallery.length<=1) return; currentIndex=(currentIndex+1)%currentGallery.length; lightboxImg.src=currentGallery[currentIndex]; caption.textContent = lightboxImg.alt = 'Image ' + (currentIndex+1) + ' of ' + currentGallery.length; }

  if (prevBtn) prevBtn.addEventListener('click', prev);
  if (nextBtn) nextBtn.addEventListener('click', next);
  if (closeBtn) closeBtn.addEventListener('click', closeLightbox);
  if (lightbox) lightbox.addEventListener('click', e => { if (e.target === lightbox) closeLightbox(); });
  document.addEventListener('keydown', e => { if (!lightbox || !lightbox.classList.contains('visible')) return; if (e.key === 'Escape') closeLightbox(); if (e.key === 'ArrowLeft') prev(); if (e.key === 'ArrowRight') next(); });

  /* NEW: smarter run that only skips when gallery/thumbs already exist */
  function runOnce(){
    const cards = Array.from(document.querySelectorAll('.report-card'));
    cards.forEach(card => {
      // skip if there's already a gallery or injected thumbs
      if (card.querySelector('.evidence-gallery') || card.querySelector('.thumb')) return;

      // determine id (report id)
      let id = card.getAttribute('data-id') || '';
      if (!id) {
        const header = card.querySelector('[id^="r-"],[id^="p-"]');
        if (header && header.id) id = header.id.replace(/^r-|^p-/, '');
      }

      // parse JSON payload and DOM tokens
      const payload = id ? parseJsonPayloadForId(id) : [];
      const dom = extractFromDom(card);
      const combined = Array.from(new Set((payload.concat(dom)).map(normalizeUrl).filter(Boolean)));
      const images = combined.filter(u => IMG_EXT_RE.test(u));
      if (images.length) injectImages(card, images);
    });

    // wire delegated click for thumbs that may be injected later
    document.removeEventListener('click', document.__evidenceClickHandler||function(){});
    document.__evidenceClickHandler = function(ev){
      const t = ev.target;
      if (!t || !t.classList) return;
      if (!(t.classList.contains('thumb') || t.classList.contains('evidence-image') || t.classList.contains('evidence-link'))) return;

      // if it's the "View evidence" link, prevent default and open gallery
      if (t.classList.contains('evidence-link')) {
        ev.preventDefault();
        const card = t.closest('.report-card');
        if (!card) { window.open(t.href, '_blank'); return; }

        const id = card.getAttribute('data-id') || (card.querySelector('[id^="r-"],[id^="p-"]') && (card.querySelector('[id^="r-"],[id^="p-"]').id || '').replace(/^r-|^p-/,''));
        let gallery = id ? parseJsonPayloadForId(id) : [];
        // fallback to DOM tokens
        if (!gallery.length) {
          gallery = extractFromDom(card).filter(u => IMG_EXT_RE.test(u));
        }
        if (!gallery.length) {
          // nothing we can show — open link in new tab
          window.open(t.href, '_blank');
          return;
        }
        // ensure thumbnails exist in the card and open lightbox
        injectImages(card, gallery);
        // prefer images found in DOM order (thumbs/evidence-image) for index mapping
        const imgs = Array.from(card.querySelectorAll('.evidence-image, .thumb')).map(i => i.src).filter(Boolean);
        openGallery(imgs.length ? imgs : gallery, 0);
        return;
      }

      // thumb or evidence-image clicked -> open the card gallery
      const card = t.closest('.report-card');
      if (!card) return;
      const imgs = Array.from(card.querySelectorAll('.evidence-image, .thumb')).map(i => i.src).filter(Boolean);
      if (imgs.length) {
        let idx = imgs.indexOf(t.src || t.getAttribute('src') || '');
        if (idx === -1) idx = 0;
        openGallery(imgs, idx);
      } else {
        // fallback: try payload
        const id = card.getAttribute('data-id') || '';
        const gallery = id ? parseJsonPayloadForId(id) : [];
        if (gallery.length) openGallery(gallery, 0);
      }
    };
    document.addEventListener('click', document.__evidenceClickHandler);
  }

  /* run on DOM ready */
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runOnce);
  } else {
    setTimeout(runOnce, 10);
  }

  window.__unified_image_fixer = { run: runOnce, parseJsonPayloadForId: parseJsonPayloadForId, injectImages: injectImages };
})();
</script>


<!-- Your main app script (keeps existing behavior) -->
<script src="/static/script.js"></script>

</body>
</html>

