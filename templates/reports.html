<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Reports - Charlie Kirk Memorial</title>
    <link rel="icon" type="image/png" href="/static/logo.png">
    <link rel="stylesheet" href="/static/style.css">
    <style>
    /* lightbox / thumb styles */
    .lightbox-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; z-index:99999; padding:20px; }
    .lightbox-overlay.visible { display:flex; }
    .lightbox-container { position: relative; max-width:95%; max-height:95%; display:flex; align-items:center; justify-content:center; overflow: visible; }
    .lightbox-image { max-width:100%; max-height:100%; border-radius:8px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); display:block; }
    .lightbox-close { position:absolute; top:8px; right:8px; background: rgba(0,0,0,0.6); color:#fff; border:none; font-size:20px; width:36px; height:36px; border-radius:6px; cursor:pointer }
    .lightbox-arrow { position:absolute; top:50%; transform:translateY(-50%); background: rgba(0,0,0,0.55); color:#fff; border:none; font-size:28px; width:48px; height:72px; cursor:pointer; border-radius:6px; display:none; align-items:center; justify-content:center; }
    .lightbox-arrow.left { left: calc(-1 * (48px + 8px)); }   /* slightly outside left */
    .lightbox-arrow.right { right: calc(-1 * (48px + 8px)); }  /* slightly outside right */
    .thumb, .evidence-image { cursor: zoom-in; max-width:100%; border-radius:4px; display:block; margin:8px 0; }
    .evidence-gallery { display:block; margin-top:8px; }
    .evidence-gallery img { max-width:180px; margin:6px; display:inline-block; vertical-align:top; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,0.35); }
    .evidence-link { display:inline-block; margin:6px 8px; padding:6px 10px; background:#222; color:#fff; border-radius:6px; text-decoration:none; }
    .report-card { background:#111; color:#ddd; padding:20px; border-radius:8px; box-shadow: 0 8px 28px rgba(0,0,0,0.45); margin:18px 0; }
    .report-evidence { margin-top:12px; }
    .lightbox-caption { margin-top:10px; color:#fff; font-size:0.95rem; text-align:center; max-width:90%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    @media (max-width:720px){ .lightbox-arrow { width:42px; height:56px; font-size:22px; left: calc(-1 * (42px + 6px)); right: calc(-1 * (42px + 6px)); } }
    </style>
</head>
<body>
<header class="header">
    <div class="header-container">
        <h1>WE ARE CHARLIE KIRK</h1>
        <nav>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/report">Report</a></li>
                <li><a href="/reports">Reports</a></li>
            </ul>
        </nav>
    </div>
</header>

<main class="reports-section">
    <div class="section-header">
        <h2>Verified Reports</h2>
        <p class="subtitle">Verified reports made public.</p>
    </div>

    <!-- FILTER CONTROLS (unchanged) -->
    <div class="reports-controls" aria-label="Filter reports">
        <div class="controls-inner">
            <label for="reports-search" class="visually-hidden">Search reports</label>
            <input id="reports-search" type="search" placeholder="Search by name, description, employer, platform..." aria-label="Search reports">
            <label for="reports-state" class="visually-hidden">Filter by state</label>
            <select id="reports-state" aria-label="Filter reports by state">
                <option value="ALL">All States</option>
                <!-- states list -->
            </select>
        </div>
        <div id="no-results" class="no-results" style="display:none;">No reports match your filter.</div>
    </div>

    <div class="reports-grid" id="reports-grid">
        {% set _seen_sigs = [] %}
        {% for report in reports %}
            {% set sig = (report.full_name or '') ~ '|' ~ (report.platform or '') ~ '|' ~ (report.description or '') ~ '|' ~ (report.evidence_url or '') %}
            {% if sig in _seen_sigs %}
            {% else %}
                {% set _seen_sigs = _seen_sigs + [sig] %}
                <article class="report-card" role="article" aria-labelledby="r-{{ report.id }}" data-id="{{ report.id }}">
                    <header class="report-card-header">
                        <h3 id="r-{{ report.id }}">{{ report.full_name or "Anonymous" }}</h3>
                        <div class="meta">
                            <span class="meta-item">{{ report.location or 'N/A' }}</span>
                            <span class="meta-sep">â€¢</span>
                            <span class="meta-item">{{ report.platform or 'Unknown' }}</span>
                        </div>
                    </header>

                    <div class="report-card-body">
                        <p class="small"><strong>Category:</strong> {{ report.category or 'N/A' }}</p>
                        <p class="small"><strong>Occupation:</strong> {{ report.occupation or 'N/A' }}</p>
                        <p class="small"><strong>Employer:</strong> {{ report.employer or 'N/A' }}</p>
                        <p class="small"><strong>Address:</strong> {{ report.address or 'N/A' }}</p>
                        <p class="small"><strong>Phone:</strong> {{ report.phone or 'N/A' }}</p>
                        <p class="small"><strong>Their Emails:</strong> {{ report.employer_email or 'N/A' }}</p>
                        <p class="desc">{{ report.description }}</p>

                        <div class="report-evidence">
                            {# server-side attempt to render evidence_url if image #}
                            {% if report.evidence_url %}
                                {% set ev2 = report.evidence_url %}
                                {% if ev2 is string %}
                                    {% set chk = ev2.strip() %}
                                    {% set candidate = chk.split('?')[0].split('#')[0].rstrip('/') %}
                                    {% set ext = candidate.rsplit('.',1)[-1]|lower if '.' in candidate else '' %}
                                    {% if ext in ['jpg','jpeg','png','gif','webp','bmp','svg'] %}
                                        <img src="{{ report.evidence_url }}" alt="Evidence" class="evidence-image" loading="lazy">
                                    {% else %}
                                        <a href="{{ report.evidence_url }}" class="evidence-link" target="_blank" rel="noopener noreferrer">View evidence</a>
                                    {% endif %}
                                {% endif %}
                            {% endif %}

                            {# server-side robust image_list construction (unchanged) #}
                            {% set image_list = [] %}
                            {% if report.image_urls %}
                                {% if report.image_urls is string %}
                                    {% set raw = report.image_urls.strip() %}
                                    {% if raw.startswith('[') and raw.endswith(']') %}
                                        {% set inner = raw[1:-1] %}
                                        {% for part in inner.split(',') %}
                                            {% set p = part.strip().strip('"').strip("'") %}
                                            {% if p %}{% set image_list = image_list + [p] %}{% endif %}
                                        {% endfor %}
                                    {% else %}
                                        {% for line in report.image_urls.splitlines() %}
                                            {% for part in line.split(',') %}
                                                {% set u = part.strip() %}
                                                {% if u.startswith('<') and u.endswith('>') %}{% set u = u[1:-1].strip() %}{% endif %}
                                                {% set u = u.strip().strip('"').strip("'") %}
                                                {% if u %}{% set image_list = image_list + [u] %}{% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                    {% endif %}
                                {% else %}
                                    {% for item in report.image_urls %}{% if item %}{% set u = item %}{% if u is string %}{% set u = u.strip() %}{% if u.startswith('<') and u.endswith('>') %}{% set u = u[1:-1].strip() %}{% endif %}{% set u = u.strip().strip('"').strip("'") %}{% endif %}{% if u %}{% set image_list = image_list + [u] %}{% endif %}{% endif %}{% endfor %}
                                {% endif %}
                            {% endif %}

                            {% for altkey in ['image_list','images_only','images','imageUrls'] %}
                                {% if report[altkey] is defined and report[altkey] %}
                                    {% if report[altkey] is string %}
                                        {% for line in report[altkey].splitlines() %}
                                            {% for part in line.split(',') %}
                                                {% set v = part.strip() %}
                                                {% if v %}{% set image_list = image_list + [v] %}{% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                    {% else %}
                                        {% for item in report[altkey] %}{% if item %}{% set image_list = image_list + [item] %}{% endif %}{% endfor %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% set seen = [] %}
                            {% set normalized = [] %}
                            {% for u in image_list %}
                                {% if u is string %}
                                    {% set uu = u.strip() %}
                                    {% if uu.startswith('<') and uu.endswith('>') %}{% set uu = uu[1:-1].strip() %}{% endif %}
                                    {% set uu = uu.strip().strip('"').strip("'") %}
                                    {% if uu and uu not in seen %}{% set seen = seen + [uu] %}{% set normalized = normalized + [uu] %}{% endif %}
                                {% endif %}
                            {% endfor %}
                            {% set image_list = normalized %}

                            {% set img_exts = ['jpg','jpeg','png','gif','webp','bmp','svg'] %}
                            {% set images_only = [] %}
                            {% if report.evidence_url %}
                                {% set ev = report.evidence_url %}
                                {% if ev is string %}
                                    {% set ev2 = ev.strip() %}
                                    {% if ev2.startswith('<') and ev2.endswith('>') %}{% set ev2 = ev2[1:-1].strip() %}{% endif %}
                                    {% set candidate = ev2.split('?')[0].split('#')[0].rstrip('/') %}
                                    {% set ext = candidate.rsplit('.',1)[-1]|lower if '.' in candidate else '' %}
                                    {% if ext in img_exts %}{% set images_only = images_only + [ev] %}{% endif %}
                                {% endif %}
                            {% endif %}
                            {% for url in image_list %}
                                {% set candidate = url.split('?')[0].split('#')[0].rstrip('/') %}
                                {% set ext = candidate.rsplit('.',1)[-1]|lower if '.' in candidate else '' %}
                                {% if ext in img_exts and (url not in images_only) %}{% set images_only = images_only + [url] %}{% endif %}
                            {% endfor %}

                            {% if image_list and image_list|length > 0 %}
                                <div class="evidence-gallery">
                                    {% for url in image_list %}
                                        {% set candidate = url.split('?')[0].split('#')[0].rstrip('/') %}
                                        {% set ext = candidate.rsplit('.',1)[-1]|lower if '.' in candidate else '' %}
                                        {% if ext in img_exts %}
                                            <img src="{{ url }}" alt="Additional evidence" class="thumb" loading="lazy">
                                        {% else %}
                                            <a href="{{ url }}" class="evidence-link" target="_blank" rel="noopener noreferrer">View link</a>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <script type="application/json" data-report-images-for="{{ report.id }}">
                            {{ (images_only or []) | tojson }}
                        </script>

                    </div>
                </article>
            {% endif %}
        {% endfor %}
    </div>
</main>

<!-- Lightbox DOM -->
<div id="lightbox" class="lightbox-overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="lightbox-container">
        <button class="lightbox-arrow left" aria-label="Previous image" id="lb-prev">&#x2190;</button>
        <img src="" alt="" class="lightbox-image" id="lightbox-img">
        <button class="lightbox-arrow right" aria-label="Next image" id="lb-next">&#x2192;</button>
        <button class="lightbox-close" aria-label="Close lightbox" id="lb-close">&times;</button>
    </div>
    <div class="lightbox-caption" id="lightbox-caption"></div>
</div>

<script>
(function(){
    'use strict';
    const IMG_EXT_RE = /\.(jpg|jpeg|png|gif|webp|bmp|svg)(?:[?#].*)?$/i;
    const HTTP_IMG_TOKEN_RE = /\bhttps?:\/\/[^\s'"]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)(?:[?#][^\s'"]*)?/gi;

    function normalizeUrl(u){ if(!u) return ''; u = (''+u).trim(); if(u.startsWith('<')&&u.endsWith('>')) u=u.slice(1,-1).trim(); if((u.startsWith('"')&&u.endsWith('"'))||(u.startsWith("'")&&u.endsWith("'"))) u=u.slice(1,-1); return u.trim(); }

    // collect JSON payloads keyed by report id
    const reportImages = {};
    Array.from(document.querySelectorAll('script[type="application/json"][data-report-images-for]')).forEach(s=>{
        const rid = (s.getAttribute('data-report-images-for')||'').toString();
        if(!rid) return;
        try {
            const parsed = JSON.parse(s.textContent || '[]');
            if(Array.isArray(parsed)) reportImages[rid] = parsed.map(normalizeUrl).filter(Boolean);
            else if(typeof parsed === 'string') reportImages[rid] = parsed.split(/[\r\n,]+/).map(normalizeUrl).filter(Boolean);
            else reportImages[rid] = [];
        } catch(e){
            const found = (s.textContent||'').match(HTTP_IMG_TOKEN_RE) || [];
            reportImages[rid] = found.map(normalizeUrl);
        }
    });

    // lightbox elements
    const lightbox = document.getElementById('lightbox');
    const imgEl = document.getElementById('lightbox-img');
    const captionEl = document.getElementById('lightbox-caption');
    const btnPrev = document.getElementById('lb-prev');
    const btnNext = document.getElementById('lb-next');
    const btnClose = document.getElementById('lb-close');
    let currentGallery = [], currentIndex = 0;

    function showLightbox(gallery, idx){
        if(!gallery || !gallery.length) return;
        currentGallery = gallery.slice();
        currentIndex = Math.max(0, Math.min(idx||0, currentGallery.length-1));
        imgEl.src = currentGallery[currentIndex];
        imgEl.alt = 'Image ' + (currentIndex+1) + ' of ' + currentGallery.length;
        captionEl.textContent = imgEl.alt;
        if(currentGallery.length > 1){ btnPrev.style.display='flex'; btnNext.style.display='flex'; } else { btnPrev.style.display='none'; btnNext.style.display='none'; }
        lightbox.classList.add('visible'); lightbox.setAttribute('aria-hidden','false');
    }
    function hideLightbox(){ lightbox.classList.remove('visible'); lightbox.setAttribute('aria-hidden','true'); imgEl.src=''; currentGallery=[]; currentIndex=0; btnPrev.style.display='none'; btnNext.style.display='none'; }
    function showPrev(){ if(currentGallery.length<=1) return; currentIndex=(currentIndex-1+currentGallery.length)%currentGallery.length; imgEl.src=currentGallery[currentIndex]; captionEl.textContent='Image '+(currentIndex+1)+' of '+currentGallery.length; }
    function showNext(){ if(currentGallery.length<=1) return; currentIndex=(currentIndex+1)%currentGallery.length; imgEl.src=currentGallery[currentIndex]; captionEl.textContent='Image '+(currentIndex+1)+' of '+currentGallery.length; }

    function extractFromDOM(card){
        const s = new Set();
        Array.from(card.querySelectorAll('img')).forEach(i=>{ if(i.src) s.add(normalizeUrl(i.src)); });
        Array.from(card.querySelectorAll('a')).forEach(a=>{ const h=a.getAttribute('href')||''; if(IMG_EXT_RE.test(h)) s.add(normalizeUrl(h)); });
        const text = card.innerText || card.textContent || '';
        let m;
        while((m=HTTP_IMG_TOKEN_RE.exec(text))!==null) s.add(normalizeUrl(m[0]));
        return Array.from(s);
    }

    function buildGallery(card, urls){
        if(!urls||!urls.length) return [];
        let gallery = card.querySelector('.evidence-gallery');
        let created=false;
        if(!gallery){ gallery=document.createElement('div'); gallery.className='evidence-gallery'; created=true; }
        const existing = new Set(Array.from(gallery.querySelectorAll('img')).map(i=>normalizeUrl(i.src)));
        const injected = [];
        urls.forEach(u=>{
            if(!u) return;
            if(!IMG_EXT_RE.test(u)) return;
            if(existing.has(u)) return;
            const img = document.createElement('img');
            img.src=u; img.alt='Additional evidence'; img.loading='lazy'; img.className='thumb'; img.setAttribute('data-auto-injected','1');
            gallery.appendChild(img);
            injected.push(u); existing.add(u);
        });
        if(created){ const evidenceContainer = card.querySelector('.report-evidence')||card.querySelector('.report-card-body')||card; evidenceContainer.appendChild(gallery); }
        return injected;
    }

    function gatherAndInjectAll(){
        const cards = Array.from(document.querySelectorAll('.report-card'));
        console.info('reports-fixer: processing', cards.length, 'cards');
        cards.forEach(card=>{
            try {
                // prefer explicit data-id (set by template)
                let rid = (card.getAttribute('data-id') || '').toString();
                // fallback: any header id starting with r- or p-
                if(!rid){
                    const header = card.querySelector('[id^="r-"],[id^="p-"]');
                    if(header && header.id){ rid = header.id.replace(/^r-|^p-/,''); }
                }
                if(!rid) rid = 'unknown';
                const payload = (reportImages[rid]||[]).map(normalizeUrl).filter(Boolean);
                const domFound = extractFromDOM(card);
                // combine with payload first
                const combined = Array.from(new Set(payload.concat(domFound)));
                const images = combined.filter(u=>IMG_EXT_RE.test(u));
                console.debug('reports-fixer:', rid, 'payload=', payload.length, 'dom=', domFound.length, 'images=', images.length);
                if(!images.length) return;
                const injected = buildGallery(card, images);
                if(injected.length) console.info('reports-fixer:', rid, 'injected', injected.length, 'images');
            } catch(e){
                console.error('reports-fixer: card error', e);
            }
        });
    }

    function wireThumbnailClicks(){
        document.querySelectorAll('.report-card').forEach(card=>{
            card.addEventListener('click', ev=>{
                const t = ev.target;
                if(!(t && t.classList)) return;
                if(!(t.classList.contains('thumb') || t.classList.contains('evidence-image'))) return;
                const imgs = Array.from(card.querySelectorAll('.evidence-image, .thumb')).map(i=>normalizeUrl(i.src)).filter(Boolean);
                const rid = card.getAttribute('data-id') || ((card.querySelector('[id^="r-"],[id^="p-"]')||{}).id||'').replace(/^r-|^p-/,'');
                const fallback = reportImages[rid] || [];
                const gallery = imgs.length? imgs : fallback;
                if(!gallery.length) return;
                const clicked = normalizeUrl(t.src || t.getAttribute('src')||'');
                let idx = gallery.indexOf(clicked); if(idx===-1) idx=0;
                showLightbox(gallery, idx);
            });
        });
    }

    // wire lightbox controls
    if(btnPrev) btnPrev.addEventListener('click', showPrev);
    if(btnNext) btnNext.addEventListener('click', showNext);
    if(btnClose) btnClose.addEventListener('click', hideLightbox);
    lightbox.addEventListener('click', e=>{ if(e.target===lightbox || e.target===captionEl) hideLightbox(); });
    document.addEventListener('keydown', e=>{ if(!lightbox.classList.contains('visible')) return; if(e.key==='Escape') hideLightbox(); if(e.key==='ArrowLeft') showPrev(); if(e.key==='ArrowRight') showNext(); });

    document.addEventListener('DOMContentLoaded', ()=>{
        try {
            gatherAndInjectAll();
            wireThumbnailClicks();
            window.__reports_image_fixer = { run: ()=>{ gatherAndInjectAll(); wireThumbnailClicks(); } };
            console.info('reports-fixer: initialized');
        } catch(e){ console.error('reports-fixer init error', e); }
    });
})();
</script>

<script src="/static/script.js"></script>
</body>
</html>
